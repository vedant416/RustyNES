(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function le(e,t){return console.log("add called"),e+t}let i;const b=new Array(128).fill(void 0);b.push(void 0,null,!0,!1);function F(e){return b[e]}let M=b.length;function ce(e){e<132||(b[e]=M,M=e)}function de(e){const t=F(e);return ce(e),t}let x=null;function V(){return(x===null||x.byteLength===0)&&(x=new Uint8Array(i.memory.buffer)),x}function X(e,t){return e=e>>>0,V().subarray(e/1,e/1+t)}const Y=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&Y.decode();function G(e,t){return e=e>>>0,Y.decode(V().subarray(e,e+t))}let A=0;function O(e,t){const n=t(e.length*1,1)>>>0;return V().set(e,n/1),A=e.length,n}let R=null;function ue(){return(R===null||R.byteLength===0)&&(R=new Float32Array(i.memory.buffer)),R}function fe(e,t){const n=t(e.length*4,4)>>>0;return ue().set(e,n/4),A=e.length,n}function _e(e){M===b.length&&b.push(b.length+1);const t=M;return M=b[t],b[t]=e,t}let S=null;function $(){return(S===null||S.byteLength===0)&&(S=new Int32Array(i.memory.buffer)),S}const J=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_nes_free(e>>>0));class D{static __wrap(t){t=t>>>0;const n=Object.create(D.prototype);return n.__wbg_ptr=t,J.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,J.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_nes_free(t)}static new_nes(t){const n=O(t,i.__wbindgen_malloc),o=A,r=i.nes_new_nes(n,o);return D.__wrap(r)}new_from_save_bytes(t){const n=O(t,i.__wbindgen_malloc),o=A,r=i.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return D.__wrap(r)}step(){i.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return i.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){i.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=fe(t,i.__wbindgen_malloc),o=A;i.nes_load_audio_buffer(this.__wbg_ptr,n,o,_e(t))}sample_rate(){return i.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=O(t,i.__wbindgen_malloc),o=A;i.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=i.__wbindgen_add_to_stack_pointer(-16);i.nes_get_state(r,this.__wbg_ptr);var t=$()[r/4+0],n=$()[r/4+1],o=X(t,n).slice();return i.__wbindgen_free(t,n*1,1),o}finally{i.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=O(t,i.__wbindgen_malloc),o=A;i.nes_set_state(this.__wbg_ptr,n,o)}throw_rust_error(){i.nes_throw_rust_error(this.__wbg_ptr)}}async function we(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function me(){const e={};return e.wbg={},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError(G(t,n))},e.wbg.__wbindgen_object_drop_ref=function(t){de(t)},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return le(t>>>0,n>>>0)},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(F(o).buffer,F(o).byteOffset,F(o).byteLength).set(X(t,n))},e.wbg.__wbindgen_throw=function(t,n){throw new Error(G(t,n))},e}function ge(e,t){return i=e.exports,Z.__wbindgen_wasm_module=t,R=null,S=null,x=null,i}async function Z(e){if(i!==void 0)return i;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=me();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await we(await e,t);return ge(n,o)}var pe=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ye={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(pe,function(){var n=function(){function o(u){return d.appendChild(u.dom),u}function r(u){for(var f=0;f<d.children.length;f++)d.children[f].style.display=f===u?"block":"none";s=u}var s=0,d=document.createElement("div");d.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",d.addEventListener("click",function(u){u.preventDefault(),r(++s%d.children.length)},!1);var w=(performance||Date).now(),_=w,l=0,c=o(new n.Panel("FPS","#0ff","#002")),g=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var B=o(new n.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:d,addPanel:o,showPanel:r,begin:function(){w=(performance||Date).now()},end:function(){l++;var u=(performance||Date).now();if(g.update(u-w,200),u>_+1e3&&(c.update(1e3*l/(u-_),100),_=u,l=0,B)){var f=performance.memory;B.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return u},update:function(){w=this.end()},domElement:d,setMode:r}};return n.Panel=function(o,r,s){var d=1/0,w=0,_=Math.round,l=_(window.devicePixelRatio||1),c=80*l,g=48*l,B=3*l,u=2*l,f=3*l,y=15*l,h=74*l,E=30*l,I=document.createElement("canvas");I.width=c,I.height=g,I.style.cssText="width:80px;height:48px";var a=I.getContext("2d");return a.font="bold "+9*l+"px Helvetica,Arial,sans-serif",a.textBaseline="top",a.fillStyle=s,a.fillRect(0,0,c,g),a.fillStyle=r,a.fillText(o,B,u),a.fillRect(f,y,h,E),a.fillStyle=s,a.globalAlpha=.9,a.fillRect(f,y,h,E),{dom:I,update:function(p,z){d=Math.min(d,p),w=Math.max(w,p),a.fillStyle=s,a.globalAlpha=1,a.fillRect(0,0,c,y),a.fillStyle=r,a.fillText(_(p)+" "+o+" ("+_(d)+"-"+_(w)+")",B,u),a.drawImage(I,f+l,y,h-l,E,f,y,h-l,E),a.fillRect(f+h-l,y,l,E),a.fillStyle=s,a.globalAlpha=.9,a.fillRect(f+h-l,y,l,_((1-p/z)*E))}}},n})})(ye);const K={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},L=256,C=240,he=L*C*4;let P=null,v=null,j=null,W=!1,T=!1,k=!0,ee,te,H,N,ne,m,Q;const be=()=>{let t=Math.floor(1e3/60),n=performance.now(),o=0;const r=s=>{P=requestAnimationFrame(r),o=s-n,!(o<t)&&(n=s-o%t,ee())};r(n)},oe=()=>{T||(T=!0,console.log("video started"),be())},ve=()=>{T&&(T=!1,console.log("video stopped"),P&&(cancelAnimationFrame(P),P=null))},Ee=()=>{v=new AudioContext({sampleRate:44100}),j=v.createScriptProcessor(1024,0,1),j.onaudioprocess=e=>{te(e)},j.connect(v.destination),console.log("audio setup")},re=async()=>{v||Ee(),W||(await(v==null?void 0:v.resume()),W=!0,console.log("audio started"))},ae=async()=>{v&&W&&(await v.suspend(),W=!1,console.log("audio stopped"))},Be=async()=>{k=!k,console.log("muted = ",k),T&&(k?await ae():await re())},q=async()=>{oe(),k||await re()},U=async()=>{await ae(),ve()};window.onError=e=>{U(),alert(e),console.error(e)};let se;const Ie=()=>{se=m.get_state()},Ae=()=>{try{m.set_state(se)}catch(e){console.log(e)}},ie=async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)},Le=async e=>{await U();const t=await ie(e);ne(t),await q()},xe=()=>{const e=document.getElementById("screen"),t=2,n=document.createElement("canvas"),o=n.getContext("2d");n.width=e.width*t,n.height=e.height*t,n.style.imageRendering="pixelated",o.imageSmoothingEnabled=!1,o.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height);const r=n.toDataURL("image/png"),s=document.createElement("a");s.href=r,s.download="canvas-image.png",s.click()},Re=()=>{let e=document.getElementById("play"),t=document.getElementById("pause"),n=document.getElementById("mute"),o=document.getElementById("save"),r=document.getElementById("load"),s=document.getElementById("downloadBtn");e.onclick=q,t.onclick=U,n.onclick=Be,o.onclick=Ie,r.onclick=Ae,s.onclick=xe;let d=document.getElementById("a"),w=document.getElementById("b"),_=document.getElementById("select"),l=document.getElementById("start"),c=document.getElementById("up"),g=document.getElementById("down"),B=document.getElementById("left"),u=document.getElementById("right"),f=[d,w,_,l,c,g,B,u],y=document.getElementsByClassName("rom"),h=Array.from(y);h.forEach(a=>{a.onclick=async p=>{let z=a.getAttribute("data-name");Le(`roms/${z}.nes`)}});const E=(a,p)=>{a.ontouchstart=()=>{a.classList.toggle("pressed"),navigator.vibrate(70),m.update_button(p,!0)},a.ontouchend=()=>{a.classList.toggle("pressed"),m.update_button(p,!1)}};return f.forEach((a,p)=>{E(a,p)}),window.addEventListener("keydown",N),window.addEventListener("keyup",H),window.onblur=()=>U(),window.onfocus=()=>q(),()=>{window.removeEventListener("keydown",N),window.removeEventListener("keyup",H),window.onblur=null,window.onfocus=null,window.onresize=null,e.onclick=null,t.onclick=null,n.onclick=null,o.onclick=null,r.onclick=null,h.forEach(a=>{a.onclick=null}),f.forEach(a=>{a.ontouchstart=null,a.ontouchend=null})}},Se=async e=>{const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(L,C);let r=document.getElementById("canvas-container");const s=Math.min(window.innerWidth/L,window.innerHeight/C,3);let d=(L-10)*s;r.style.width=d+"px",window.onresize=()=>{const c=Math.min(window.innerWidth/L,window.innerHeight/C,3);let g=(L-10)*c;r.style.width=g+"px"};const w=await ie(e),_=await Z();window.wasm=_,Q=_.memory,m=D.new_nes(w),window.nes=m;const l=(c,g)=>{c.key in K&&(c.preventDefault(),m.update_button(K[c.key],g))};N=c=>{l(c,!0)},H=c=>{l(c,!1)},ee=()=>{m.step(),o.data.set(new Uint8ClampedArray(Q.buffer,m.frame_buffer_pointer(),he)),n.putImageData(o,0,0)},te=c=>m.load_audio_buffer(c.outputBuffer.getChannelData(0)),ne=c=>m.change_rom(c),Re()},ke=async()=>{await Se("roms/mario.nes"),oe()};document.addEventListener("DOMContentLoaded",ke);
