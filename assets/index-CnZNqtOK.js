(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))o(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function n(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(a){if(a.ep)return;a.ep=!0;const s=n(a);fetch(a.href,s)}})();function le(e,t){return console.log("add called"),e+t}let i;const b=new Array(128).fill(void 0);b.push(void 0,null,!0,!1);function F(e){return b[e]}let k=b.length;function ce(e){e<132||(b[e]=k,k=e)}function ue(e){const t=F(e);return ce(e),t}let x=null;function V(){return(x===null||x.byteLength===0)&&(x=new Uint8Array(i.memory.buffer)),x}function X(e,t){return e=e>>>0,V().subarray(e/1,e/1+t)}const Y=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&Y.decode();function G(e,t){return e=e>>>0,Y.decode(V().subarray(e,e+t))}let I=0;function T(e,t){const n=t(e.length*1,1)>>>0;return V().set(e,n/1),I=e.length,n}let R=null;function de(){return(R===null||R.byteLength===0)&&(R=new Float32Array(i.memory.buffer)),R}function fe(e,t){const n=t(e.length*4,4)>>>0;return de().set(e,n/4),I=e.length,n}function _e(e){k===b.length&&b.push(b.length+1);const t=k;return k=b[t],b[t]=e,t}let S=null;function K(){return(S===null||S.byteLength===0)&&(S=new Int32Array(i.memory.buffer)),S}const $=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_nes_free(e>>>0));class D{static __wrap(t){t=t>>>0;const n=Object.create(D.prototype);return n.__wbg_ptr=t,$.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,$.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_nes_free(t)}static new_nes(t){const n=T(t,i.__wbindgen_malloc),o=I,a=i.nes_new_nes(n,o);return D.__wrap(a)}new_from_save_bytes(t){const n=T(t,i.__wbindgen_malloc),o=I,a=i.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return D.__wrap(a)}step(){i.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return i.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){i.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=fe(t,i.__wbindgen_malloc),o=I;i.nes_load_audio_buffer(this.__wbg_ptr,n,o,_e(t))}sample_rate(){return i.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=T(t,i.__wbindgen_malloc),o=I;i.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const a=i.__wbindgen_add_to_stack_pointer(-16);i.nes_get_state(a,this.__wbg_ptr);var t=K()[a/4+0],n=K()[a/4+1],o=X(t,n).slice();return i.__wbindgen_free(t,n*1,1),o}finally{i.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=T(t,i.__wbindgen_malloc),o=I;i.nes_set_state(this.__wbg_ptr,n,o)}throw_rust_error(){i.nes_throw_rust_error(this.__wbg_ptr)}}async function me(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function we(){const e={};return e.wbg={},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError(G(t,n))},e.wbg.__wbindgen_object_drop_ref=function(t){ue(t)},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return le(t>>>0,n>>>0)},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(F(o).buffer,F(o).byteOffset,F(o).byteLength).set(X(t,n))},e.wbg.__wbindgen_throw=function(t,n){throw new Error(G(t,n))},e}function pe(e,t){return i=e.exports,Z.__wbindgen_wasm_module=t,R=null,S=null,x=null,i}async function Z(e){if(i!==void 0)return i;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=we();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await me(await e,t);return pe(n,o)}var ge=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ye={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(ge,function(){var n=function(){function o(d){return u.appendChild(d.dom),d}function a(d){for(var f=0;f<u.children.length;f++)u.children[f].style.display=f===d?"block":"none";s=d}var s=0,u=document.createElement("div");u.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",u.addEventListener("click",function(d){d.preventDefault(),a(++s%u.children.length)},!1);var p=(performance||Date).now(),m=p,l=0,c=o(new n.Panel("FPS","#0ff","#002")),g=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var B=o(new n.Panel("MB","#f08","#201"));return a(0),{REVISION:16,dom:u,addPanel:o,showPanel:a,begin:function(){p=(performance||Date).now()},end:function(){l++;var d=(performance||Date).now();if(g.update(d-p,200),d>m+1e3&&(c.update(1e3*l/(d-m),100),m=d,l=0,B)){var f=performance.memory;B.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return d},update:function(){p=this.end()},domElement:u,setMode:a}};return n.Panel=function(o,a,s){var u=1/0,p=0,m=Math.round,l=m(window.devicePixelRatio||1),c=80*l,g=48*l,B=3*l,d=2*l,f=3*l,y=15*l,h=74*l,E=30*l,L=document.createElement("canvas");L.width=c,L.height=g,L.style.cssText="width:80px;height:48px";var r=L.getContext("2d");return r.font="bold "+9*l+"px Helvetica,Arial,sans-serif",r.textBaseline="top",r.fillStyle=s,r.fillRect(0,0,c,g),r.fillStyle=a,r.fillText(o,B,d),r.fillRect(f,y,h,E),r.fillStyle=s,r.globalAlpha=.9,r.fillRect(f,y,h,E),{dom:L,update:function(w,z){u=Math.min(u,w),p=Math.max(p,w),r.fillStyle=s,r.globalAlpha=1,r.fillRect(0,0,c,y),r.fillStyle=a,r.fillText(m(w)+" "+o+" ("+m(u)+"-"+m(p)+")",B,d),r.drawImage(L,f+l,y,h-l,E,f,y,h-l,E),r.fillRect(f+h-l,y,l,E),r.fillStyle=s,r.globalAlpha=.9,r.fillRect(f+h-l,y,l,m((1-w/z)*E))}}},n})})(ye);const J={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},A=256,C=240,he=A*C*4;let P=null,v=null,j=null,W=!1,O=!1,M=!0,ee,te,H,N,ne,_,Q;const be=()=>{let t=Math.floor(1e3/60),n=performance.now(),o=0;const a=s=>{P=requestAnimationFrame(a),o=s-n,!(o<t)&&(n=s-o%t,ee())};a(n)},oe=()=>{O||(O=!0,console.log("video started"),be())},ve=()=>{O&&(O=!1,console.log("video stopped"),P&&(cancelAnimationFrame(P),P=null))},Ee=()=>{v=new AudioContext({sampleRate:44100}),j=v.createScriptProcessor(1024,0,1),j.onaudioprocess=e=>{te(e)},j.connect(v.destination),console.log("audio setup")},re=async()=>{v||Ee(),W||(await(v==null?void 0:v.resume()),W=!0,console.log("audio started"))},ae=async()=>{v&&W&&(await v.suspend(),W=!1,console.log("audio stopped"))},Be=async()=>{M=!M,console.log("muted = ",M),O&&(M?await ae():await re())},q=async()=>{oe(),M||await re()},U=async()=>{await ae(),ve()};window.onError=e=>{U(),alert(e),console.error(e)};let se;const Le=()=>{se=_.get_state()},Ie=()=>{try{_.set_state(se)}catch(e){console.log(e)}},ie=async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)},Ae=async e=>{await U();const t=await ie(e);ne(t),await q()},xe=()=>{const e=document.getElementById("screen"),t=2,n=document.createElement("canvas"),o=n.getContext("2d");n.width=e.width*t,n.height=e.height*t,n.style.imageRendering="pixelated",o.imageSmoothingEnabled=!1,o.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height);const a=n.toDataURL("image/png"),s=document.createElement("a");s.href=a,s.download="canvas-image.png",s.click()},Re=()=>{let e=document.getElementById("play"),t=document.getElementById("pause"),n=document.getElementById("mute"),o=document.getElementById("save"),a=document.getElementById("load"),s=document.getElementById("downloadBtn");e.onclick=q,t.onclick=U,n.onclick=Be,o.onclick=Le,a.onclick=Ie,s.onclick=xe;let u=document.getElementsByClassName("rom"),p=Array.from(u);p.forEach(r=>{r.onclick=async w=>{let z=r.getAttribute("data-name");Ae(`roms/${z}.nes`)}});let m=document.getElementById("a"),l=document.getElementById("b"),c=document.getElementById("select"),g=document.getElementById("start"),B=document.getElementById("up"),d=document.getElementById("down"),f=document.getElementById("left"),y=document.getElementById("right"),h=[m,l,c,g,B,d,f,y];const E=(r,w)=>{r.ontouchstart=()=>{r.classList.toggle("pressed"),navigator.vibrate(70),_.update_button(w,!0)},r.ontouchend=()=>{r.classList.toggle("pressed"),_.update_button(w,!1)},r.ontouchcancel=()=>{r.classList.remove("pressed"),_.update_button(w,!1)},r.onmousedown=()=>{r.classList.toggle("pressed"),_.update_button(w,!0)},r.onmouseup=()=>{r.classList.toggle("pressed"),_.update_button(w,!1)},r.onmouseleave=()=>{r.classList.remove("pressed"),_.update_button(w,!1)}};return h.forEach((r,w)=>{E(r,w)}),window.addEventListener("keydown",N),window.addEventListener("keyup",H),window.onblur=()=>U(),window.onfocus=()=>q(),()=>{window.removeEventListener("keydown",N),window.removeEventListener("keyup",H),window.onblur=null,window.onfocus=null,window.onresize=null,n.onclick=null,e.onclick=null,t.onclick=null,o.onclick=null,a.onclick=null,p.forEach(r=>{r.onclick=null}),h.forEach(r=>{r.ontouchstart=null,r.ontouchend=null,r.ontouchcancel=null,r.onmousedown=null,r.onmouseup=null,r.onmouseleave=null})}},Se=async e=>{const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(A,C);let a=document.getElementById("canvas-container");const s=Math.min(window.innerWidth/A,window.innerHeight/C);let u=(A-5)*s;a.style.width=u+"px",window.onresize=()=>{const c=Math.min(window.innerWidth/A,window.innerHeight/C);let g=(A-5)*c;a.style.width=g+"px"};const p=await ie(e),m=await Z();window.wasm=m,Q=m.memory,_=D.new_nes(p),window.nes=_;const l=(c,g)=>{c.key in J&&(c.preventDefault(),_.update_button(J[c.key],g))};N=c=>{l(c,!0)},H=c=>{l(c,!1)},ee=()=>{_.step(),o.data.set(new Uint8ClampedArray(Q.buffer,_.frame_buffer_pointer(),he)),n.putImageData(o,0,0)},te=c=>_.load_audio_buffer(c.outputBuffer.getChannelData(0)),ne=c=>_.change_rom(c),Re()},Me=async()=>{await Se("roms/mario.nes"),oe()};document.addEventListener("DOMContentLoaded",Me);
