(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();function ue(e,t){return console.log("add called"),e+t}let d,T=null;function A(){return(T===null||T.byteLength===0)&&(T=new Uint8Array(d.memory.buffer)),T}function Q(e,t){return e=e>>>0,A().subarray(e/1,e/1+t)}const h=new Array(128).fill(void 0);h.push(void 0,null,!0,!1);function S(e){return h[e]}let M=h.length;function _e(e){e<132||(h[e]=M,M=e)}function me(e){const t=S(e);return _e(e),t}const X=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&X.decode();function $(e,t){return e=e>>>0,X.decode(A().subarray(e,e+t))}let y=0;function O(e,t){const n=t(e.length*1,1)>>>0;return A().set(e,n/1),y=e.length,n}let B=null;function pe(){return(B===null||B.byteLength===0)&&(B=new Float32Array(d.memory.buffer)),B}function we(e,t){const n=t(e.length*4,4)>>>0;return pe().set(e,n/4),y=e.length,n}function Y(e){M===h.length&&h.push(h.length+1);const t=M;return M=h[t],h[t]=e,t}let R=null;function j(){return(R===null||R.byteLength===0)&&(R=new Int32Array(d.memory.buffer)),R}const P=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},ge=typeof P.encodeInto=="function"?function(e,t){return P.encodeInto(e,t)}:function(e,t){const n=P.encode(e);return t.set(n),{read:e.length,written:n.length}};function ye(e,t,n){if(n===void 0){const c=P.encode(e),f=t(c.length,1)>>>0;return A().subarray(f,f+c.length).set(c),y=c.length,f}let o=e.length,r=t(o,1)>>>0;const i=A();let a=0;for(;a<o;a++){const c=e.charCodeAt(a);if(c>127)break;i[r+a]=c}if(a!==o){a!==0&&(e=e.slice(a)),r=n(r,o,o=a+e.length*3,1)>>>0;const c=A().subarray(r+a,r+o),f=ge(e,c);a+=f.written,r=n(r,o,a,1)>>>0}return y=a,r}const G=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>d.__wbg_nes_free(e>>>0));class k{static __wrap(t){t=t>>>0;const n=Object.create(k.prototype);return n.__wbg_ptr=t,G.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,G.unregister(this),t}free(){const t=this.__destroy_into_raw();d.__wbg_nes_free(t)}static new_nes(t){const n=O(t,d.__wbindgen_malloc),o=y,r=d.nes_new_nes(n,o);return k.__wrap(r)}new_from_save_bytes(t){const n=O(t,d.__wbindgen_malloc),o=y,r=d.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return k.__wrap(r)}step(){d.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return d.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){d.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=we(t,d.__wbindgen_malloc),o=y;d.nes_load_audio_buffer(this.__wbg_ptr,n,o,Y(t))}sample_rate(){return d.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=O(t,d.__wbindgen_malloc),o=y;d.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=d.__wbindgen_add_to_stack_pointer(-16);d.nes_get_state(r,this.__wbg_ptr);var t=j()[r/4+0],n=j()[r/4+1],o=Q(t,n).slice();return d.__wbindgen_free(t,n*1,1),o}finally{d.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=O(t,d.__wbindgen_malloc),o=y;d.nes_set_state(this.__wbg_ptr,n,o)}}async function be(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function he(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(S(o).buffer,S(o).byteOffset,S(o).byteLength).set(Q(t,n))},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return ue(t>>>0,n>>>0)},e.wbg.__wbindgen_object_drop_ref=function(t){me(t)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return Y(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,n){const o=S(n).stack,r=ye(o,d.__wbindgen_malloc,d.__wbindgen_realloc),i=y;j()[t/4+1]=i,j()[t/4+0]=r},e.wbg.__wbg_error_f851667af71bcfc6=function(t,n){let o,r;try{o=t,r=n,console.error($(t,n))}finally{d.__wbindgen_free(o,r,1)}},e.wbg.__wbindgen_throw=function(t,n){throw new Error($(t,n))},e}function Ee(e,t){return d=e.exports,Z.__wbindgen_wasm_module=t,B=null,R=null,T=null,d}async function Z(e){if(d!==void 0)return d;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=he();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await be(await e,t);return Ee(n,o)}var ve=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function xe(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ee={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(ve,function(){var n=function(){function o(_){return a.appendChild(_.dom),_}function r(_){for(var p=0;p<a.children.length;p++)a.children[p].style.display=p===_?"block":"none";i=_}var i=0,a=document.createElement("div");a.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",a.addEventListener("click",function(_){_.preventDefault(),r(++i%a.children.length)},!1);var c=(performance||Date).now(),f=c,s=0,l=o(new n.Panel("FPS","#0ff","#002")),m=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var b=o(new n.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:a,addPanel:o,showPanel:r,begin:function(){c=(performance||Date).now()},end:function(){s++;var _=(performance||Date).now();if(m.update(_-c,200),_>f+1e3&&(l.update(1e3*s/(_-f),100),f=_,s=0,b)){var p=performance.memory;b.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return _},update:function(){c=this.end()},domElement:a,setMode:r}};return n.Panel=function(o,r,i){var a=1/0,c=0,f=Math.round,s=f(window.devicePixelRatio||1),l=80*s,m=48*s,b=3*s,_=2*s,p=3*s,E=15*s,v=74*s,x=30*s,L=document.createElement("canvas");L.width=l,L.height=m,L.style.cssText="width:80px;height:48px";var u=L.getContext("2d");return u.font="bold "+9*s+"px Helvetica,Arial,sans-serif",u.textBaseline="top",u.fillStyle=i,u.fillRect(0,0,l,m),u.fillStyle=r,u.fillText(o,b,_),u.fillRect(p,E,v,x),u.fillStyle=i,u.globalAlpha=.9,u.fillRect(p,E,v,x),{dom:L,update:function(F,fe){a=Math.min(a,F),c=Math.max(c,F),u.fillStyle=i,u.globalAlpha=1,u.fillRect(0,0,l,E),u.fillStyle=r,u.fillText(f(F)+" "+o+" ("+f(a)+"-"+f(c)+")",b,_),u.drawImage(L,p+s,E,v-s,x,p,E,v-s,x),u.fillRect(p+v-s,E,s,x),u.fillStyle=i,u.globalAlpha=.9,u.fillRect(p+v-s,E,s,f((1-F/fe)*x))}}},n})})(ee);var Le=ee.exports;const H=xe(Le),J={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},I=256,W=240,Ie=I*W*4;async function te(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}let U=null,w=null,N=null,D=!1,C=!1,ne,oe,re,ae,se,g,K;const ie=()=>{C||(C=!0,Te())},Ae=()=>{C&&(C=!1,U&&(cancelAnimationFrame(U),U=null))},Te=()=>{window.performance.now();let e=0,n=Math.floor(1e3/61),r=performance.now(),i=0,a=0,c=document.querySelector(".stats");var f=new H;f.showPanel(0),f.domElement.style.cssText="position:absolute;top:0px;left:0px;",c.appendChild(f.domElement);var s=new H;s.showPanel(1),s.domElement.style.cssText="position:absolute;top:0px;left:80px;",c.appendChild(s.domElement);var l=new H;l.showPanel(2),l.domElement.style.cssText="position:absolute;top:0px;left:160px;",c.appendChild(l.domElement);const m=b=>{U=requestAnimationFrame(m),f.begin(),i=b,a=i-r,!(a<n)&&(console.log(`Rendering too fast + ${e}`),r=i-a%n,e++,ne(),f.end())};requestAnimationFrame(m)},Se=()=>{w=new AudioContext({sampleRate:48e3}),w.onstatechange=()=>{console.log(w==null?void 0:w.state)},N=w.createScriptProcessor(1024,0,1),N.onaudioprocess=e=>{oe(e)},N.connect(w.destination),console.log("audio setup")},q=async()=>{w||Se(),!D&&(await(w==null?void 0:w.resume()),D=!0,console.log("audio playing"))},le=async()=>{w&&D&&(await w.suspend(),D=!1,console.log("audio paused"))},ce=async()=>{ie(),!z&&await q()},de=async()=>{await le(),Ae()};let Be=document.getElementById("play"),Re=document.getElementById("pause"),Me=document.getElementById("mute"),z=!1;const ke=()=>{window.addEventListener("keydown",ae),window.addEventListener("keyup",re),Be.addEventListener("click",ce),Re.addEventListener("click",de),Me.addEventListener("click",async()=>{C&&(w?D?await le():await q():await q(),z=!z)}),[...document.getElementsByClassName("rom")].forEach(l=>{l.addEventListener("click",async m=>{let b=l.getAttribute("data-name");De(`roms/${b}.nes`)})});let t=document.getElementById("up"),n=document.getElementById("down"),o=document.getElementById("left"),r=document.getElementById("right"),i=document.getElementById("a"),a=document.getElementById("b"),c=document.getElementById("select"),f=document.getElementById("start");const s=(l,m)=>{l.addEventListener("touchstart",()=>{l.classList.toggle("pressed"),navigator.vibrate(70),g.update_button(m,!0)}),l.addEventListener("touchend",()=>{l.classList.toggle("pressed"),g.update_button(m,!1)})};s(i,0),s(a,1),s(c,2),s(f,3),s(t,4),s(n,5),s(o,6),s(r,7)},De=async e=>{await de();const t=await te(e);se(t),await ce()},Ce=async e=>{const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(I,W);let r=document.getElementById("canvas-container");console.log(r);const i=Math.min(window.innerWidth/I,window.innerHeight/W,3);let a=(I-10)*i;r.style.width=a+"px",window.addEventListener("resize",()=>{const l=Math.min(window.innerWidth/I,window.innerHeight/W,3);let m=(I-10)*l;r.style.width=m+"px"});const c=await te(e),f=await Z();window.wasm=f,K=f.memory,g=k.new_nes(c);const s=(l,m)=>{l.key in J&&(l.preventDefault(),g.update_button(J[l.key],m))};ae=l=>{s(l,!0)},re=l=>{s(l,!1)},ne=()=>{g.step(),o.data.set(new Uint8ClampedArray(K.buffer,g.frame_buffer_pointer(),Ie)),n.putImageData(o,0,0)},oe=l=>{g.load_audio_buffer(l.outputBuffer.getChannelData(0))},se=l=>{g.change_rom(l)},ke()},Fe=async()=>{let e=document.getElementById("save"),t=document.getElementById("load");e.onclick=Oe,t.onclick=Pe;const n=document.getElementById("screen");n.getContext("2d"),document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const o=document.createElement("canvas");o.style.imageRendering="pixelated";const r=2;o.width=n.width*r,o.height=n.height*r;const i=o.getContext("2d");i.imageSmoothingEnabled=!1,i.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const a=o.toDataURL("image/png"),c=document.createElement("a");c.href=a,c.download="canvas-image.png",c.click()}),await Ce("roms/mario.nes"),ie()};let V;const Oe=()=>{V=g.get_state(),console.log(V)},Pe=()=>{try{g.set_state(V)}catch(e){console.log(e)}};document.addEventListener("DOMContentLoaded",Fe);
