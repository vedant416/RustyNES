(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const c of l.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(r){if(r.ep)return;r.ep=!0;const l=n(r);fetch(r.href,l)}})();function me(e,t){return console.log("add called"),e+t}let i,R=null;function V(){return(R===null||R.byteLength===0)&&(R=new Uint8Array(i.memory.buffer)),R}function ee(e,t){return e=e>>>0,V().subarray(e/1,e/1+t)}const y=new Array(128).fill(void 0);y.push(void 0,null,!0,!1);function C(e){return y[e]}let F=y.length;function ge(e){e<132||(y[e]=F,F=e)}function pe(e){const t=C(e);return ge(e),t}const te=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&te.decode();function $(e,t){return e=e>>>0,te.decode(V().subarray(e,e+t))}let v=0;function O(e,t){const n=t(e.length*1,1)>>>0;return V().set(e,n/1),v=e.length,n}let S=null;function we(){return(S===null||S.byteLength===0)&&(S=new Float32Array(i.memory.buffer)),S}function ye(e,t){const n=t(e.length*4,4)>>>0;return we().set(e,n/4),v=e.length,n}function he(e){F===y.length&&y.push(y.length+1);const t=F;return F=y[t],y[t]=e,t}let M=null;function J(){return(M===null||M.byteLength===0)&&(M=new Int32Array(i.memory.buffer)),M}const K=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_nes_free(e>>>0));class P{static __wrap(t){t=t>>>0;const n=Object.create(P.prototype);return n.__wbg_ptr=t,K.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,K.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_nes_free(t)}static new_nes(t){const n=O(t,i.__wbindgen_malloc),o=v,r=i.nes_new_nes(n,o);return P.__wrap(r)}new_from_save_bytes(t){const n=O(t,i.__wbindgen_malloc),o=v,r=i.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return P.__wrap(r)}step(){i.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return i.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){i.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=ye(t,i.__wbindgen_malloc),o=v;i.nes_load_audio_buffer(this.__wbg_ptr,n,o,he(t))}sample_rate(){return i.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=O(t,i.__wbindgen_malloc),o=v;i.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=i.__wbindgen_add_to_stack_pointer(-16);i.nes_get_state(r,this.__wbg_ptr);var t=J()[r/4+0],n=J()[r/4+1],o=ee(t,n).slice();return i.__wbindgen_free(t,n*1,1),o}finally{i.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=O(t,i.__wbindgen_malloc),o=v;i.nes_set_state(this.__wbg_ptr,n,o)}throw_rust_error(){i.nes_throw_rust_error(this.__wbg_ptr)}}async function be(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function ve(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(C(o).buffer,C(o).byteOffset,C(o).byteLength).set(ee(t,n))},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError($(t,n))},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return me(t>>>0,n>>>0)},e.wbg.__wbindgen_object_drop_ref=function(t){pe(t)},e.wbg.__wbindgen_throw=function(t,n){throw new Error($(t,n))},e}function Ee(e,t){return i=e.exports,ne.__wbindgen_wasm_module=t,S=null,M=null,R=null,i}async function ne(e){if(i!==void 0)return i;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=ve();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await be(await e,t);return Ee(n,o)}var Le=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Be(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var oe={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(Le,function(){var n=function(){function o(m){return c.appendChild(m.dom),m}function r(m){for(var p=0;p<c.children.length;p++)c.children[p].style.display=p===m?"block":"none";l=m}var l=0,c=document.createElement("div");c.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",c.addEventListener("click",function(m){m.preventDefault(),r(++l%c.children.length)},!1);var d=(performance||Date).now(),f=d,a=0,s=o(new n.Panel("FPS","#0ff","#002")),g=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=o(new n.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:c,addPanel:o,showPanel:r,begin:function(){d=(performance||Date).now()},end:function(){a++;var m=(performance||Date).now();if(g.update(m-d,200),m>f+1e3&&(s.update(1e3*a/(m-f),100),f=m,a=0,h)){var p=performance.memory;h.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return m},update:function(){d=this.end()},domElement:c,setMode:r}};return n.Panel=function(o,r,l){var c=1/0,d=0,f=Math.round,a=f(window.devicePixelRatio||1),s=80*a,g=48*a,h=3*a,m=2*a,p=3*a,b=15*a,E=74*a,L=30*a,B=document.createElement("canvas");B.width=s,B.height=g,B.style.cssText="width:80px;height:48px";var u=B.getContext("2d");return u.font="bold "+9*a+"px Helvetica,Arial,sans-serif",u.textBaseline="top",u.fillStyle=l,u.fillRect(0,0,s,g),u.fillStyle=r,u.fillText(o,h,m),u.fillRect(p,b,E,L),u.fillStyle=l,u.globalAlpha=.9,u.fillRect(p,b,E,L),{dom:B,update:function(k,_e){c=Math.min(c,k),d=Math.max(d,k),u.fillStyle=l,u.globalAlpha=1,u.fillRect(0,0,s,b),u.fillStyle=r,u.fillText(f(k)+" "+o+" ("+f(c)+"-"+f(d)+")",h,m),u.drawImage(B,p+a,b,E-a,L,p,b,E-a,L),u.fillRect(p+E-a,b,a,L),u.fillStyle=l,u.globalAlpha=.9,u.fillRect(p+E-a,b,a,f((1-k/_e)*L))}}},n})})(oe);var xe=oe.exports;const Q=Be(xe),X={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},x=256,q=240,Ae=x*q*4;async function re(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}let W=null,_=null,j=null,D=!1,T=!1,ae,se,ie,le,ce,w,Y,Z=!1,A,I;const de=()=>{if(console.log("startVideo"),!Z){Z=!0;let e=document.querySelector(".stats");A=new Q,A.showPanel(0),A.dom.style.cssText="",e.appendChild(A.dom),I=new Q,I.showPanel(1),I.dom.style.cssText="",e.appendChild(I.dom)}T||(T=!0,Re())},Ie=()=>{T&&(T=!1,W&&(cancelAnimationFrame(W),W=null))};window.onError=e=>{G(),alert(e),console.error(e)};const Re=()=>{let e=window.performance.now(),t=0,n=0,o=e,r=0,c=Math.floor(1e3/60),d=performance.now(),f=0;const a=s=>{if(A.begin(),I.begin(),W=requestAnimationFrame(a),f=s-d,f<c){console.log("Rendering too fast");return}if(d=s-f%c,t++,ae(),r=s-o,n+=r,o=s,t%60===0){let g=1e3/(n/60);console.log(g.toFixed(2)),t=0,n=0}A.end(),I.end()};a(d)},Se=()=>{_=new AudioContext({sampleRate:44100}),_.onstatechange=()=>{console.log(_==null?void 0:_.state)},j=_.createScriptProcessor(1024,0,1),j.onaudioprocess=o=>{se(o)};let e=_.createBiquadFilter();e.type="highpass",e.frequency.value=90;let t=_.createBiquadFilter();t.type="highpass",t.frequency.value=440;let n=_.createBiquadFilter();n.type="lowpass",n.frequency.value=14e3,j.connect(_.destination),console.log("audio setup")},N=async()=>{_||Se(),!D&&(await(_==null?void 0:_.resume()),D=!0,console.log("audio playing"))},ue=async()=>{_&&D&&(await _.suspend(),D=!1,console.log("audio paused"))},fe=async()=>{de(),!H&&await N()},G=async()=>{await ue(),Ie()};let Me=document.getElementById("play"),Fe=document.getElementById("pause"),Pe=document.getElementById("mute"),H=!1;const De=()=>{window.addEventListener("keydown",le),window.addEventListener("keyup",ie),Me.addEventListener("click",fe),Fe.addEventListener("click",G),Pe.addEventListener("click",async()=>{T&&(_?D?await ue():await N():await N(),H=!H)}),[...document.getElementsByClassName("rom")].forEach(s=>{s.addEventListener("click",async g=>{let h=s.getAttribute("data-name");Te(`roms/${h}.nes`)})});let t=document.getElementById("up"),n=document.getElementById("down"),o=document.getElementById("left"),r=document.getElementById("right"),l=document.getElementById("a"),c=document.getElementById("b"),d=document.getElementById("select"),f=document.getElementById("start");const a=(s,g)=>{s.addEventListener("touchstart",()=>{s.classList.toggle("pressed"),navigator.vibrate(70),w.update_button(g,!0)}),s.addEventListener("touchend",()=>{s.classList.toggle("pressed"),w.update_button(g,!1)})};a(l,0),a(c,1),a(d,2),a(f,3),a(t,4),a(n,5),a(o,6),a(r,7)},Te=async e=>{await G();const t=await re(e);ce(t),await fe()},ke=async e=>{console.log("init called with url ",e);const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(x,q);let r=document.getElementById("canvas-container");console.log(r);const l=Math.min(window.innerWidth/x,window.innerHeight/q,3);let c=(x-10)*l;r.style.width=c+"px",window.addEventListener("resize",()=>{const s=Math.min(window.innerWidth/x,window.innerHeight/q,3);let g=(x-10)*s;r.style.width=g+"px"});const d=await re(e),f=await ne();window.wasm=f,Y=f.memory,w=P.new_nes(d),window.nes=w;const a=(s,g)=>{s.key in X&&(s.preventDefault(),w.update_button(X[s.key],g))};le=s=>{a(s,!0)},ie=s=>{a(s,!1)},ae=()=>{w.step(),o.data.set(new Uint8ClampedArray(Y.buffer,w.frame_buffer_pointer(),Ae)),n.putImageData(o,0,0)},se=s=>{w.load_audio_buffer(s.outputBuffer.getChannelData(0))},ce=s=>{w.change_rom(s)},De()},Oe=async()=>{console.log("inside main");let e=document.getElementById("save"),t=document.getElementById("load");e.onclick=Ce,t.onclick=qe;const n=document.getElementById("screen");n.getContext("2d"),document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const o=document.createElement("canvas");o.style.imageRendering="pixelated";const r=2;o.width=n.width*r,o.height=n.height*r;const l=o.getContext("2d");l.imageSmoothingEnabled=!1,l.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const c=o.toDataURL("image/png"),d=document.createElement("a");d.href=c,d.download="canvas-image.png",d.click()}),console.log("before init"),await ke("roms/mario.nes"),console.log("after init"),de()};let z;const Ce=()=>{z=w.get_state(),console.log(z)},qe=()=>{try{w.set_state(z)}catch(e){console.log(e)}};document.addEventListener("DOMContentLoaded",()=>{Oe().then(()=>console.log("after main"))});let U=indexedDB.open("wasm",1);U.onerror=e=>{console.log("error",e),console.log(U.error)};U.onsuccess=e=>{console.log("success",e),console.log(U.result)};
