(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();function ee(t,e){return console.log("add called"),t+e}let s,p=null;function w(){return(p===null||p.byteLength===0)&&(p=new Uint8Array(s.memory.buffer)),p}function N(t,e){return t=t>>>0,w().subarray(t/1,t/1+e)}const m=new Array(128).fill(void 0);m.push(void 0,null,!0,!1);function y(t){return m[t]}let E=m.length;function te(t){t<132||(m[t]=E,E=t)}function ne(t){const e=y(t);return te(t),e}const j=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&j.decode();function M(t,e){return t=t>>>0,j.decode(w().subarray(t,t+e))}let f=0;function A(t,e){const n=e(t.length*1,1)>>>0;return w().set(t,n/1),f=t.length,n}let b=null;function oe(){return(b===null||b.byteLength===0)&&(b=new Float32Array(s.memory.buffer)),b}function re(t,e){const n=e(t.length*4,4)>>>0;return oe().set(t,n/4),f=t.length,n}function q(t){E===m.length&&m.push(m.length+1);const e=E;return E=m[e],m[e]=t,e}let h=null;function C(){return(h===null||h.byteLength===0)&&(h=new Int32Array(s.memory.buffer)),h}const B=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},se=typeof B.encodeInto=="function"?function(t,e){return B.encodeInto(t,e)}:function(t,e){const n=B.encode(t);return e.set(n),{read:t.length,written:n.length}};function ae(t,e,n){if(n===void 0){const l=B.encode(t),c=e(l.length,1)>>>0;return w().subarray(c,c+l.length).set(l),f=l.length,c}let o=t.length,r=e(o,1)>>>0;const a=w();let i=0;for(;i<o;i++){const l=t.charCodeAt(i);if(l>127)break;a[r+i]=l}if(i!==o){i!==0&&(t=t.slice(i)),r=n(r,o,o=i+t.length*3,1)>>>0;const l=w().subarray(r+i,r+o),c=se(t,l);i+=c.written,r=n(r,o,i,1)>>>0}return f=i,r}const S=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_nes_free(t>>>0));class v{static __wrap(e){e=e>>>0;const n=Object.create(v.prototype);return n.__wbg_ptr=e,S.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,S.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_nes_free(e)}static new_nes(e){const n=A(e,s.__wbindgen_malloc),o=f,r=s.nes_new_nes(n,o);return v.__wrap(r)}step(){s.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return s.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(e,n){s.nes_update_button(this.__wbg_ptr,e,n)}load_audio_buffer(e){var n=re(e,s.__wbindgen_malloc),o=f;s.nes_load_audio_buffer(this.__wbg_ptr,n,o,q(e))}sample_rate(){return s.nes_sample_rate(this.__wbg_ptr)}change_rom(e){const n=A(e,s.__wbindgen_malloc),o=f;s.nes_change_rom(this.__wbg_ptr,n,o)}static new_nes_from_save(e){const n=A(e,s.__wbindgen_malloc),o=f,r=s.nes_new_nes_from_save(n,o);return v.__wrap(r)}get_state(){try{const r=s.__wbindgen_add_to_stack_pointer(-16);s.nes_get_state(r,this.__wbg_ptr);var e=C()[r/4+0],n=C()[r/4+1],o=N(e,n).slice();return s.__wbindgen_free(e,n*1,1),o}finally{s.__wbindgen_add_to_stack_pointer(16)}}set_state(e){const n=A(e,s.__wbindgen_malloc),o=f;s.nes_set_state(this.__wbg_ptr,n,o)}}async function ie(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(o){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function ce(){const t={};return t.wbg={},t.wbg.__wbindgen_copy_to_typed_array=function(e,n,o){new Uint8Array(y(o).buffer,y(o).byteOffset,y(o).byteLength).set(N(e,n))},t.wbg.__wbg_add_1f5a7f294ef132d5=function(e,n){return ee(e>>>0,n>>>0)},t.wbg.__wbindgen_object_drop_ref=function(e){ne(e)},t.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return q(e)},t.wbg.__wbg_stack_658279fe44541cf6=function(e,n){const o=y(n).stack,r=ae(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=f;C()[e/4+1]=a,C()[e/4+0]=r},t.wbg.__wbg_error_f851667af71bcfc6=function(e,n){let o,r;try{o=e,r=n,console.error(M(e,n))}finally{s.__wbindgen_free(o,r,1)}},t.wbg.__wbindgen_throw=function(e,n){throw new Error(M(e,n))},t}function le(t,e){return s=t.exports,z.__wbindgen_wasm_module=e,b=null,h=null,p=null,s}async function z(t){if(s!==void 0)return s;typeof t>"u"&&(t=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const e=ce();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:o}=await ie(await t,e);return le(n,o)}const W={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},R=256,x=240,de=R*x*4;async function H(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch ROM: ${e.statusText}`);const n=await e.arrayBuffer();return new Uint8Array(n)}let k=null,_=null,T=null,L=!1,I=!1,V,$,G,K,J,u,P;const Q=()=>{I||(I=!0,fe())},ue=()=>{I&&(I=!1,k&&(cancelAnimationFrame(k),k=null))},fe=()=>{let e=window.performance.now(),n=0,o=0;const r=()=>{if(k=requestAnimationFrame(r),o=window.performance.now(),n=o-e,n<16.67){console.log("Rendering too fast");return}e=o-n%16.67,V()};r()},_e=()=>{_=new AudioContext({sampleRate:48e3}),T=_.createScriptProcessor(1024,0,1),T.onaudioprocess=t=>{$(t)},T.connect(_.destination),console.log("audio setup")},O=async()=>{_||_e(),!L&&(await(_==null?void 0:_.resume()),L=!0,console.log("audio playing"))},X=async()=>{_&&L&&(await _.suspend(),L=!1,console.log("audio paused"))},Y=async()=>{Q(),await O()},Z=async()=>{await X(),ue()};let me=document.getElementById("play"),ge=document.getElementById("pause"),we=document.getElementById("mute");const pe=()=>{window.addEventListener("keydown",K),window.addEventListener("keyup",G),me.addEventListener("click",Y),ge.addEventListener("click",Z),we.addEventListener("click",async()=>{I&&(_?L?await X():await O():await O())}),[...document.getElementsByClassName("rom")].forEach(g=>{g.addEventListener("click",async F=>{ye(`roms/${g.textContent}.nes`)})});let e=document.getElementById("up"),n=document.getElementById("down"),o=document.getElementById("left"),r=document.getElementById("right"),a=document.getElementById("a"),i=document.getElementById("b"),l=document.getElementById("select"),c=document.getElementById("start");const d=(g,F)=>{g.addEventListener("touchstart",()=>{g.classList.toggle("pressed"),navigator.vibrate(70),u.update_button(F,!0)}),g.addEventListener("touchend",()=>{g.classList.toggle("pressed"),u.update_button(F,!1)})};d(a,0),d(i,1),d(l,2),d(c,3),d(e,4),d(n,5),d(o,6),d(r,7)},ye=async t=>{await Z();const e=await H(t);J(e),await Y()},be=async t=>{const e=document.querySelector("#screen"),n=e.getContext("2d"),o=n.createImageData(R,x);let r=e.parentElement;console.log(r),U(e),document.addEventListener("resize",()=>U(e));const a=await H(t);P=(await z()).memory,u=v.new_nes(a);const l=(c,d)=>{c.key in W&&(c.preventDefault(),u.update_button(W[c.key],d))};K=c=>{l(c,!0)},G=c=>{l(c,!1)},V=()=>{u.step(),o.data.set(new Uint8ClampedArray(P.buffer,u.frame_buffer_pointer(),de)),n.putImageData(o,0,0)},$=c=>{u.load_audio_buffer(c.outputBuffer.getChannelData(0))},J=c=>{u.change_rom(c)},pe()};function U(t){const e=Math.min(window.innerWidth/R,window.innerHeight/x);t.style.width=`${R*e-10}px`,t.style.height=`${x*e-10}px`}const he=async()=>{let t=document.getElementById("save"),e=document.getElementById("load");t.onclick=Ee,e.onclick=ve;const n=document.getElementById("screen");n.getContext("2d"),document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const o=document.createElement("canvas");o.style.imageRendering="pixelated";const r=2;o.width=n.width*r,o.height=n.height*r;const a=o.getContext("2d");a.imageSmoothingEnabled=!1,a.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const i=o.toDataURL("image/png"),l=document.createElement("a");l.href=i,l.download="canvas-image.png",l.click()}),await be("roms/mario.nes"),Q()};let D;const Ee=()=>{D=u.get_state(),console.log(D)},ve=()=>{u.set_state(D)};document.addEventListener("DOMContentLoaded",he);
