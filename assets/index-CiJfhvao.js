(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();function $(e,t){return console.log("add called"),e+t}let s,m=null;function w(){return(m===null||m.byteLength===0)&&(m=new Uint8Array(s.memory.buffer)),m}function G(e,t){return e=e>>>0,w().subarray(e/1,e/1+t)}const f=new Array(128).fill(void 0);f.push(void 0,null,!0,!1);function b(e){return f[e]}let g=f.length;function K(e){e<132||(f[e]=g,g=e)}function J(e){const t=b(e);return K(e),t}const x=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&x.decode();function k(e,t){return e=e>>>0,x.decode(w().subarray(e,e+t))}let _=0;function C(e,t){const n=t(e.length*1,1)>>>0;return w().set(e,n/1),_=e.length,n}let y=null;function Q(){return(y===null||y.byteLength===0)&&(y=new Float32Array(s.memory.buffer)),y}function X(e,t){const n=t(e.length*4,4)>>>0;return Q().set(e,n/4),_=e.length,n}function M(e){g===f.length&&f.push(f.length+1);const t=g;return g=f[t],f[t]=e,t}const A=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},Y=typeof A.encodeInto=="function"?function(e,t){return A.encodeInto(e,t)}:function(e,t){const n=A.encode(e);return t.set(n),{read:e.length,written:n.length}};function Z(e,t,n){if(n===void 0){const c=A.encode(e),d=t(c.length,1)>>>0;return w().subarray(d,d+c.length).set(c),_=c.length,d}let r=e.length,o=t(r,1)>>>0;const i=w();let a=0;for(;a<r;a++){const c=e.charCodeAt(a);if(c>127)break;i[o+a]=c}if(a!==r){a!==0&&(e=e.slice(a)),o=n(o,r,r=a+e.length*3,1)>>>0;const c=w().subarray(o+a,o+r),d=Y(e,c);a+=d.written,o=n(o,r,a,1)>>>0}return _=a,o}let p=null;function O(){return(p===null||p.byteLength===0)&&(p=new Int32Array(s.memory.buffer)),p}const T=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_nes_free(e>>>0));class v{static __wrap(t){t=t>>>0;const n=Object.create(v.prototype);return n.__wbg_ptr=t,T.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,T.unregister(this),t}free(){const t=this.__destroy_into_raw();s.__wbg_nes_free(t)}static new_nes(t){const n=C(t,s.__wbindgen_malloc),r=_,o=s.nes_new_nes(n,r);return v.__wrap(o)}step(){s.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return s.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){s.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=X(t,s.__wbindgen_malloc),r=_;s.nes_load_audio_buffer(this.__wbg_ptr,n,r,M(t))}sample_rate(){return s.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=C(t,s.__wbindgen_malloc),r=_;s.nes_change_rom(this.__wbg_ptr,n,r)}}async function ee(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function te(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,r){new Uint8Array(b(r).buffer,b(r).byteOffset,b(r).byteLength).set(G(t,n))},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return $(t>>>0,n>>>0)},e.wbg.__wbindgen_object_drop_ref=function(t){J(t)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return M(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,n){const r=b(n).stack,o=Z(r,s.__wbindgen_malloc,s.__wbindgen_realloc),i=_;O()[t/4+1]=i,O()[t/4+0]=o},e.wbg.__wbg_error_f851667af71bcfc6=function(t,n){let r,o;try{r=t,o=n,console.error(k(t,n))}finally{s.__wbindgen_free(r,o,1)}},e.wbg.__wbindgen_throw=function(t,n){throw new Error(k(t,n))},e}function ne(e,t){return s=e.exports,D.__wbindgen_wasm_module=t,y=null,p=null,m=null,s}async function D(e){if(s!==void 0)return s;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=te();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await ee(await e,t);return ne(n,r)}const I={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},S=256,W=240,re=S*W*4;async function B(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}let L=null,u=null,F=null,h=!1,E=!1,P,N,U,j,q;const V=()=>{E||(E=!0,se())},oe=()=>{E&&(E=!1,L&&(cancelAnimationFrame(L),L=null))},se=()=>{let t=window.performance.now(),n=0,r=0;const o=()=>{if(L=requestAnimationFrame(o),r=window.performance.now(),n=r-t,n<16.67){console.log("Rendering too fast");return}t=r-n%16.67,P()};o()},ae=()=>{u=new AudioContext({sampleRate:48e3}),F=u.createScriptProcessor(1024,0,1),F.onaudioprocess=e=>{N(e)},F.connect(u.destination),console.log("audio setup")},R=async()=>{u||ae(),!h&&(await(u==null?void 0:u.resume()),h=!0,console.log("audio playing"))},z=async()=>{u&&h&&(await u.suspend(),h=!1,console.log("audio paused"))},ie=async()=>{V(),await R()},ce=async()=>{await z(),oe()};let le=document.getElementById("play"),ue=document.getElementById("pause"),fe=document.getElementById("mute");const de=()=>{window.addEventListener("keydown",j),window.addEventListener("keyup",U),le.addEventListener("click",ie),ue.addEventListener("click",ce),fe.addEventListener("click",async()=>{E&&(u?h?await z():await R():await R())}),[...document.getElementsByClassName("rom")].forEach(t=>{t.addEventListener("click",async n=>{let r=await B(`roms/${t.textContent}.nes`);q(r)})})},_e=async e=>{const n=document.querySelector("#screen").getContext("2d"),r=n.createImageData(S,W),o=await B(e),a=(await D()).memory,c=v.new_nes(o),d=(l,H)=>{l.key in I&&(l.preventDefault(),c.update_button(I[l.key],H))};j=l=>{d(l,!0)},U=l=>{d(l,!1)},P=()=>{c.step(),r.data.set(new Uint8ClampedArray(a.buffer,c.frame_buffer_pointer(),re)),n.putImageData(r,0,0)},N=l=>{c.load_audio_buffer(l.outputBuffer.getChannelData(0))},q=l=>{c.change_rom(l)},de()},we=async()=>{await _e("roms/mario.nes"),V()};document.addEventListener("DOMContentLoaded",we);
