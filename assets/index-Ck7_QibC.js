(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function _e(e,t){return console.log("add called"),e+t}let i;const E=new Array(128).fill(void 0);E.push(void 0,null,!0,!1);function j(e){return E[e]}let O=E.length;function we(e){e<132||(E[e]=O,O=e)}function me(e){const t=j(e);return we(e),t}let k=null;function $(){return(k===null||k.byteLength===0)&&(k=new Uint8Array(i.memory.buffer)),k}function te(e,t){return e=e>>>0,$().subarray(e/1,e/1+t)}const ne=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&ne.decode();function J(e,t){return e=e>>>0,ne.decode($().subarray(e,e+t))}let I=0;function U(e,t){const n=t(e.length*1,1)>>>0;return $().set(e,n/1),I=e.length,n}let M=null;function pe(){return(M===null||M.byteLength===0)&&(M=new Float32Array(i.memory.buffer)),M}function ge(e,t){const n=t(e.length*4,4)>>>0;return pe().set(e,n/4),I=e.length,n}function ye(e){O===E.length&&E.push(E.length+1);const t=O;return O=E[t],E[t]=e,t}let D=null;function K(){return(D===null||D.byteLength===0)&&(D=new Int32Array(i.memory.buffer)),D}const Q=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_nes_free(e>>>0));class C{static __wrap(t){t=t>>>0;const n=Object.create(C.prototype);return n.__wbg_ptr=t,Q.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Q.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_nes_free(t)}static new_nes(t){const n=U(t,i.__wbindgen_malloc),o=I,r=i.nes_new_nes(n,o);return C.__wrap(r)}new_from_save_bytes(t){const n=U(t,i.__wbindgen_malloc),o=I,r=i.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return C.__wrap(r)}step(){i.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return i.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){i.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=ge(t,i.__wbindgen_malloc),o=I;i.nes_load_audio_buffer(this.__wbg_ptr,n,o,ye(t))}sample_rate(){return i.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=U(t,i.__wbindgen_malloc),o=I;i.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=i.__wbindgen_add_to_stack_pointer(-16);i.nes_get_state(r,this.__wbg_ptr);var t=K()[r/4+0],n=K()[r/4+1],o=te(t,n).slice();return i.__wbindgen_free(t,n*1,1),o}finally{i.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=U(t,i.__wbindgen_malloc),o=I;i.nes_set_state(this.__wbg_ptr,n,o)}throw_rust_error(){i.nes_throw_rust_error(this.__wbg_ptr)}}async function he(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function be(){const e={};return e.wbg={},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError(J(t,n))},e.wbg.__wbindgen_object_drop_ref=function(t){me(t)},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return _e(t>>>0,n>>>0)},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(j(o).buffer,j(o).byteOffset,j(o).byteLength).set(te(t,n))},e.wbg.__wbindgen_throw=function(t,n){throw new Error(J(t,n))},e}function ve(e,t){return i=e.exports,oe.__wbindgen_wasm_module=t,M=null,D=null,k=null,i}async function oe(e){if(i!==void 0)return i;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=be();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await he(await e,t);return ve(n,o)}var Ee=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Be(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var re={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(Ee,function(){var n=function(){function o(u){return c.appendChild(u.dom),u}function r(u){for(var f=0;f<c.children.length;f++)c.children[f].style.display=f===u?"block":"none";s=u}var s=0,c=document.createElement("div");c.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",c.addEventListener("click",function(u){u.preventDefault(),r(++s%c.children.length)},!1);var w=(performance||Date).now(),_=w,l=0,h=o(new n.Panel("FPS","#0ff","#002")),d=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var g=o(new n.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:c,addPanel:o,showPanel:r,begin:function(){w=(performance||Date).now()},end:function(){l++;var u=(performance||Date).now();if(d.update(u-w,200),u>_+1e3&&(h.update(1e3*l/(u-_),100),_=u,l=0,g)){var f=performance.memory;g.update(f.usedJSHeapSize/1048576,f.jsHeapSizeLimit/1048576)}return u},update:function(){w=this.end()},domElement:c,setMode:r}};return n.Panel=function(o,r,s){var c=1/0,w=0,_=Math.round,l=_(window.devicePixelRatio||1),h=80*l,d=48*l,g=3*l,u=2*l,f=3*l,b=15*l,v=74*l,B=30*l,A=document.createElement("canvas");A.width=h,A.height=d,A.style.cssText="width:80px;height:48px";var a=A.getContext("2d");return a.font="bold "+9*l+"px Helvetica,Arial,sans-serif",a.textBaseline="top",a.fillStyle=s,a.fillRect(0,0,h,d),a.fillStyle=r,a.fillText(o,g,u),a.fillRect(f,b,v,B),a.fillStyle=s,a.globalAlpha=.9,a.fillRect(f,b,v,B),{dom:A,update:function(y,q){c=Math.min(c,y),w=Math.max(w,y),a.fillStyle=s,a.globalAlpha=1,a.fillRect(0,0,h,b),a.fillStyle=r,a.fillText(_(y)+" "+o+" ("+_(c)+"-"+_(w)+")",g,u),a.drawImage(A,f+l,b,v-l,B,f,b,v-l,B),a.fillRect(f+v-l,b,l,B),a.fillStyle=s,a.globalAlpha=.9,a.fillRect(f+v-l,b,l,_((1-y/q)*B))}}},n})})(re);var Ae=re.exports;const X=Be(Ae),Y={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},x=256,z=240,Ie=x*z*4;let H=null,p=null,L=null,P=!1,F=!1,T=!0,ae,se,N,V,ie,m,Z,ee=!1,S,R;const Le=()=>{let t=Math.floor(1e3/60),n=performance.now(),o=0;const r=s=>{S.begin(),R.begin(),H=requestAnimationFrame(r),o=s-n,!(o<t)&&(n=s-o%t,ae(),S.end(),R.end())};r(n)},le=()=>{if(!ee){ee=!0;let e=document.querySelector(".stats");S=new X,S.showPanel(0),S.dom.style.cssText="",e.appendChild(S.dom),R=new X,R.showPanel(1),R.dom.style.cssText="",e.appendChild(R.dom)}F||(F=!0,console.log("video started"),Le())},xe=()=>{F&&(F=!1,console.log("video stopped"),H&&(cancelAnimationFrame(H),H=null))},Se=()=>{p=new AudioContext({sampleRate:44100}),L=p.createScriptProcessor(1024,0,1),L.onaudioprocess=e=>{se(e)},L.connect(p.destination),console.log("audio setup")},ce=async()=>{p||Se(),P||(await(p==null?void 0:p.resume()),P=!0,console.log("audio started"))},de=async()=>{p&&P&&(await p.suspend(),P=!1,console.log("audio stopped"))},Re=async()=>{p&&(L==null||L.disconnect(),await p.close(),p=null,L=null,P=!1,console.log("audio stopped"))},ke=async()=>{T=!T,console.log("muted = ",T),F&&(T?await de():await ce())},G=async()=>{le(),T||await ce()},W=async()=>{await de(),xe()},Me=async()=>{W(),await Re(),m.free()};window.onError=e=>{W(),alert(e),console.error(e)};let ue;const De=()=>{ue=m.get_state()},Te=()=>{try{m.set_state(ue)}catch(e){console.log(e)}},fe=async e=>{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)},Oe=async e=>{await W();const t=await fe(e);ie(t),await G()},Ce=()=>{const e=document.getElementById("screen"),t=2,n=document.createElement("canvas"),o=n.getContext("2d");n.width=e.width*t,n.height=e.height*t,n.style.imageRendering="pixelated",o.imageSmoothingEnabled=!1,o.drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height);const r=n.toDataURL("image/png"),s=document.createElement("a");s.href=r,s.download="canvas-image.png",s.click()},Pe=()=>{let e=document.getElementById("play"),t=document.getElementById("pause"),n=document.getElementById("mute"),o=document.getElementById("save"),r=document.getElementById("load"),s=document.getElementById("downloadBtn");e.onclick=G,t.onclick=W,n.onclick=ke,o.onclick=De,r.onclick=Te,s.onclick=Ce;let c=document.getElementById("a"),w=document.getElementById("b"),_=document.getElementById("select"),l=document.getElementById("start"),h=document.getElementById("up"),d=document.getElementById("down"),g=document.getElementById("left"),u=document.getElementById("right"),f=[c,w,_,l,h,d,g,u],b=document.getElementsByClassName("rom"),v=Array.from(b);v.forEach(a=>{a.onclick=async y=>{let q=a.getAttribute("data-name");Oe(`roms/${q}.nes`)}});const B=(a,y)=>{a.ontouchstart=()=>{a.classList.toggle("pressed"),navigator.vibrate(70),m.update_button(y,!0)},a.ontouchend=()=>{a.classList.toggle("pressed"),m.update_button(y,!1)}};return f.forEach((a,y)=>{B(a,y)}),window.addEventListener("keydown",V),window.addEventListener("keyup",N),window.onblur=()=>W(),window.onfocus=()=>G(),()=>{window.removeEventListener("keydown",V),window.removeEventListener("keyup",N),window.onblur=null,window.onfocus=null,window.onresize=null,e.onclick=null,t.onclick=null,n.onclick=null,o.onclick=null,r.onclick=null,v.forEach(a=>{a.onclick=null}),f.forEach(a=>{a.ontouchstart=null,a.ontouchend=null})}},Fe=async e=>{const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(x,z);let r=document.getElementById("canvas-container");const s=Math.min(window.innerWidth/x,window.innerHeight/z,3);let c=(x-10)*s;r.style.width=c+"px",window.onresize=()=>{const d=Math.min(window.innerWidth/x,window.innerHeight/z,3);let g=(x-10)*d;r.style.width=g+"px"};const w=await fe(e),_=await oe();window.wasm=_,Z=_.memory,m=C.new_nes(w),window.nes=m;const l=(d,g)=>{d.key in Y&&(d.preventDefault(),m.update_button(Y[d.key],g))};V=d=>{l(d,!0)},N=d=>{l(d,!1)},ae=()=>{m.step(),o.data.set(new Uint8ClampedArray(Z.buffer,m.frame_buffer_pointer(),Ie)),n.putImageData(o,0,0)},se=d=>m.load_audio_buffer(d.outputBuffer.getChannelData(0)),ie=d=>m.change_rom(d);let h=Pe();window.onbeforeunload=async()=>{await Me(),h()}},We=async()=>{await Fe("roms/mario.nes"),le()};document.addEventListener("DOMContentLoaded",We);
