(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();function te(t,e){return console.log("add called"),t+e}let s,b=null;function p(){return(b===null||b.byteLength===0)&&(b=new Uint8Array(s.memory.buffer)),b}function N(t,e){return t=t>>>0,p().subarray(t/1,t/1+e)}const g=new Array(128).fill(void 0);g.push(void 0,null,!0,!1);function h(t){return g[t]}let L=g.length;function ne(t){t<132||(g[t]=L,L=t)}function oe(t){const e=h(t);return ne(t),e}const j=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&j.decode();function W(t,e){return t=t>>>0,j.decode(p().subarray(t,t+e))}let w=0;function R(t,e){const n=e(t.length*1,1)>>>0;return p().set(t,n/1),w=t.length,n}let E=null;function re(){return(E===null||E.byteLength===0)&&(E=new Float32Array(s.memory.buffer)),E}function se(t,e){const n=e(t.length*4,4)>>>0;return re().set(t,n/4),w=t.length,n}function H(t){L===g.length&&g.push(g.length+1);const e=L;return L=g[e],g[e]=t,e}let v=null;function M(){return(v===null||v.byteLength===0)&&(v=new Int32Array(s.memory.buffer)),v}const F=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},ae=typeof F.encodeInto=="function"?function(t,e){return F.encodeInto(t,e)}:function(t,e){const n=F.encode(t);return e.set(n),{read:t.length,written:n.length}};function ie(t,e,n){if(n===void 0){const l=F.encode(t),f=e(l.length,1)>>>0;return p().subarray(f,f+l.length).set(l),w=l.length,f}let o=t.length,r=e(o,1)>>>0;const a=p();let i=0;for(;i<o;i++){const l=t.charCodeAt(i);if(l>127)break;a[r+i]=l}if(i!==o){i!==0&&(t=t.slice(i)),r=n(r,o,o=i+t.length*3,1)>>>0;const l=p().subarray(r+i,r+o),f=ae(t,l);i+=f.written,r=n(r,o,i,1)>>>0}return w=i,r}const C=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_nes_free(t>>>0));class I{static __wrap(e){e=e>>>0;const n=Object.create(I.prototype);return n.__wbg_ptr=e,C.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,C.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_nes_free(e)}static new_nes(e){const n=R(e,s.__wbindgen_malloc),o=w,r=s.nes_new_nes(n,o);return I.__wrap(r)}new_from_save_bytes(e){const n=R(e,s.__wbindgen_malloc),o=w,r=s.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return I.__wrap(r)}step(){s.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return s.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(e,n){s.nes_update_button(this.__wbg_ptr,e,n)}load_audio_buffer(e){var n=se(e,s.__wbindgen_malloc),o=w;s.nes_load_audio_buffer(this.__wbg_ptr,n,o,H(e))}sample_rate(){return s.nes_sample_rate(this.__wbg_ptr)}change_rom(e){const n=R(e,s.__wbindgen_malloc),o=w;s.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=s.__wbindgen_add_to_stack_pointer(-16);s.nes_get_state(r,this.__wbg_ptr);var e=M()[r/4+0],n=M()[r/4+1],o=N(e,n).slice();return s.__wbindgen_free(e,n*1,1),o}finally{s.__wbindgen_add_to_stack_pointer(16)}}set_state(e){const n=R(e,s.__wbindgen_malloc),o=w;s.nes_set_state(this.__wbg_ptr,n,o)}}async function ce(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(o){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function le(){const t={};return t.wbg={},t.wbg.__wbindgen_copy_to_typed_array=function(e,n,o){new Uint8Array(h(o).buffer,h(o).byteOffset,h(o).byteLength).set(N(e,n))},t.wbg.__wbg_add_1f5a7f294ef132d5=function(e,n){return te(e>>>0,n>>>0)},t.wbg.__wbindgen_object_drop_ref=function(e){oe(e)},t.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return H(e)},t.wbg.__wbg_stack_658279fe44541cf6=function(e,n){const o=h(n).stack,r=ie(o,s.__wbindgen_malloc,s.__wbindgen_realloc),a=w;M()[e/4+1]=a,M()[e/4+0]=r},t.wbg.__wbg_error_f851667af71bcfc6=function(e,n){let o,r;try{o=e,r=n,console.error(W(e,n))}finally{s.__wbindgen_free(o,r,1)}},t.wbg.__wbindgen_throw=function(e,n){throw new Error(W(e,n))},t}function de(t,e){return s=t.exports,q.__wbindgen_wasm_module=e,E=null,v=null,b=null,s}async function q(t){if(s!==void 0)return s;typeof t>"u"&&(t=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const e=le();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:o}=await ce(await t,e);return de(n,o)}const P={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},y=256,k=240,ue=y*k*4;async function z(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch ROM: ${e.statusText}`);const n=await e.arrayBuffer();return new Uint8Array(n)}let x=null,d=null,T=null,A=!1,B=!1,V,$,G,K,J,_,U;const Q=()=>{B||(B=!0,_e())},fe=()=>{B&&(B=!1,x&&(cancelAnimationFrame(x),x=null))},_e=()=>{let e=window.performance.now(),n=0,o=0;const r=()=>{if(x=requestAnimationFrame(r),o=window.performance.now(),n=o-e,n<16.67){console.log("Rendering too fast");return}e=o-n%16.67,V()};r()},we=()=>{d=new AudioContext({sampleRate:48e3}),d.onstatechange=()=>{console.log(d==null?void 0:d.state)},T=d.createScriptProcessor(1024,0,1),T.onaudioprocess=t=>{$(t)},T.connect(d.destination),console.log("audio setup")},O=async()=>{d||we(),!A&&(await(d==null?void 0:d.resume()),A=!0,console.log("audio playing"))},X=async()=>{d&&A&&(await d.suspend(),A=!1,console.log("audio paused"))},Y=async()=>{Q(),!S&&await O()},Z=async()=>{await X(),fe()};let ge=document.getElementById("play"),me=document.getElementById("pause"),ye=document.getElementById("mute"),S=!1;const pe=()=>{window.addEventListener("keydown",K),window.addEventListener("keyup",G),ge.addEventListener("click",Y),me.addEventListener("click",Z),ye.addEventListener("click",async()=>{B&&(d?A?await X():await O():await O(),S=!S)}),[...document.getElementsByClassName("rom")].forEach(c=>{c.addEventListener("click",async m=>{let ee=c.getAttribute("data-name");be(`roms/${ee}.nes`)})});let e=document.getElementById("up"),n=document.getElementById("down"),o=document.getElementById("left"),r=document.getElementById("right"),a=document.getElementById("a"),i=document.getElementById("b"),l=document.getElementById("select"),f=document.getElementById("start");const u=(c,m)=>{c.addEventListener("touchstart",()=>{c.classList.toggle("pressed"),navigator.vibrate(70),_.update_button(m,!0)}),c.addEventListener("touchend",()=>{c.classList.toggle("pressed"),_.update_button(m,!1)})};u(a,0),u(i,1),u(l,2),u(f,3),u(e,4),u(n,5),u(o,6),u(r,7)},be=async t=>{await Z();const e=await z(t);J(e),await Y()},he=async t=>{const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(y,k);let r=document.getElementById("canvas-container");console.log(r);const a=Math.min(window.innerWidth/y,window.innerHeight/k,3);let i=(y-10)*a;r.style.width=i+"px",window.addEventListener("resize",()=>{const c=Math.min(window.innerWidth/y,window.innerHeight/k,3);let m=(y-10)*c;r.style.width=m+"px"});const l=await z(t),f=await q();window.wasm=f,U=f.memory,_=I.new_nes(l);const u=(c,m)=>{c.key in P&&(c.preventDefault(),_.update_button(P[c.key],m))};K=c=>{u(c,!0)},G=c=>{u(c,!1)},V=()=>{_.step(),o.data.set(new Uint8ClampedArray(U.buffer,_.frame_buffer_pointer(),ue)),n.putImageData(o,0,0)},$=c=>{_.load_audio_buffer(c.outputBuffer.getChannelData(0))},J=c=>{_.change_rom(c)},pe()},Ee=async()=>{let t=document.getElementById("save"),e=document.getElementById("load");t.onclick=ve,e.onclick=Le;const n=document.getElementById("screen");n.getContext("2d"),document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const o=document.createElement("canvas");o.style.imageRendering="pixelated";const r=2;o.width=n.width*r,o.height=n.height*r;const a=o.getContext("2d");a.imageSmoothingEnabled=!1,a.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const i=o.toDataURL("image/png"),l=document.createElement("a");l.href=i,l.download="canvas-image.png",l.click()}),await he("roms/mario.nes"),Q()};let D;const ve=()=>{D=_.get_state(),console.log(D)},Le=()=>{try{_.set_state(D)}catch(t){console.log(t)}};document.addEventListener("DOMContentLoaded",Ee);
