(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function me(e,t){return console.log("add called"),e+t}let i,S=null;function G(){return(S===null||S.byteLength===0)&&(S=new Uint8Array(i.memory.buffer)),S}function ee(e,t){return e=e>>>0,G().subarray(e/1,e/1+t)}const y=new Array(128).fill(void 0);y.push(void 0,null,!0,!1);function W(e){return y[e]}let T=y.length;function ge(e){e<132||(y[e]=T,T=e)}function we(e){const t=W(e);return ge(e),t}const te=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&te.decode();function J(e,t){return e=e>>>0,te.decode(G().subarray(e,e+t))}let v=0;function F(e,t){const n=t(e.length*1,1)>>>0;return G().set(e,n/1),v=e.length,n}let M=null;function pe(){return(M===null||M.byteLength===0)&&(M=new Float32Array(i.memory.buffer)),M}function ye(e,t){const n=t(e.length*4,4)>>>0;return pe().set(e,n/4),v=e.length,n}function he(e){T===y.length&&y.push(y.length+1);const t=T;return T=y[t],y[t]=e,t}let D=null;function K(){return(D===null||D.byteLength===0)&&(D=new Int32Array(i.memory.buffer)),D}const Q=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_nes_free(e>>>0));class k{static __wrap(t){t=t>>>0;const n=Object.create(k.prototype);return n.__wbg_ptr=t,Q.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,Q.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_nes_free(t)}static new_nes(t){const n=F(t,i.__wbindgen_malloc),o=v,r=i.nes_new_nes(n,o);return k.__wrap(r)}new_from_save_bytes(t){const n=F(t,i.__wbindgen_malloc),o=v,r=i.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return k.__wrap(r)}step(){i.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return i.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){i.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=ye(t,i.__wbindgen_malloc),o=v;i.nes_load_audio_buffer(this.__wbg_ptr,n,o,he(t))}sample_rate(){return i.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=F(t,i.__wbindgen_malloc),o=v;i.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=i.__wbindgen_add_to_stack_pointer(-16);i.nes_get_state(r,this.__wbg_ptr);var t=K()[r/4+0],n=K()[r/4+1],o=ee(t,n).slice();return i.__wbindgen_free(t,n*1,1),o}finally{i.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=F(t,i.__wbindgen_malloc),o=v;i.nes_set_state(this.__wbg_ptr,n,o)}throw_rust_error(){i.nes_throw_rust_error(this.__wbg_ptr)}}async function be(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function ve(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(W(o).buffer,W(o).byteOffset,W(o).byteLength).set(ee(t,n))},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError(J(t,n))},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return me(t>>>0,n>>>0)},e.wbg.__wbindgen_object_drop_ref=function(t){we(t)},e.wbg.__wbindgen_throw=function(t,n){throw new Error(J(t,n))},e}function Ee(e,t){return i=e.exports,ne.__wbindgen_wasm_module=t,M=null,D=null,S=null,i}async function ne(e){if(i!==void 0)return i;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=ve();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await be(await e,t);return Ee(n,o)}var Le=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Ae(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var oe={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(Le,function(){var n=function(){function o(f){return c.appendChild(f.dom),f}function r(f){for(var m=0;m<c.children.length;m++)c.children[m].style.display=m===f?"block":"none";s=f}var s=0,c=document.createElement("div");c.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",c.addEventListener("click",function(f){f.preventDefault(),r(++s%c.children.length)},!1);var u=(performance||Date).now(),_=u,a=0,l=o(new n.Panel("FPS","#0ff","#002")),w=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=o(new n.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:c,addPanel:o,showPanel:r,begin:function(){u=(performance||Date).now()},end:function(){a++;var f=(performance||Date).now();if(w.update(f-u,200),f>_+1e3&&(l.update(1e3*a/(f-_),100),_=f,a=0,h)){var m=performance.memory;h.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return f},update:function(){u=this.end()},domElement:c,setMode:r}};return n.Panel=function(o,r,s){var c=1/0,u=0,_=Math.round,a=_(window.devicePixelRatio||1),l=80*a,w=48*a,h=3*a,f=2*a,m=3*a,b=15*a,E=74*a,L=30*a,A=document.createElement("canvas");A.width=l,A.height=w,A.style.cssText="width:80px;height:48px";var d=A.getContext("2d");return d.font="bold "+9*a+"px Helvetica,Arial,sans-serif",d.textBaseline="top",d.fillStyle=s,d.fillRect(0,0,l,w),d.fillStyle=r,d.fillText(o,h,f),d.fillRect(m,b,E,L),d.fillStyle=s,d.globalAlpha=.9,d.fillRect(m,b,E,L),{dom:A,update:function(P,_e){c=Math.min(c,P),u=Math.max(u,P),d.fillStyle=s,d.globalAlpha=1,d.fillRect(0,0,l,b),d.fillStyle=r,d.fillText(_(P)+" "+o+" ("+_(c)+"-"+_(u)+")",h,f),d.drawImage(A,m+a,b,E-a,L,m,b,E-a,L),d.fillRect(m+E-a,b,a,L),d.fillStyle=s,d.globalAlpha=.9,d.fillRect(m+E-a,b,a,_((1-P/_e)*L))}}},n})})(oe);var Ie=oe.exports;const H=Ae(Ie),X={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},I=256,U=240,xe=I*U*4;async function re(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}let j=null,g=null,N=null,C=!1,O=!1,ae,se,ie,le,ce,p,Y,Z=!1,x,B,R;const de=()=>{if(console.log("startVideo"),!Z){Z=!0;let e=document.querySelector(".stats");x=new H,x.showPanel(0),x.dom.style.cssText="",e.appendChild(x.dom),B=new H,B.showPanel(1),B.dom.style.cssText="",e.appendChild(B.dom),R=new H,R.showPanel(2),R.dom.style.cssText="",e.appendChild(R.dom)}O||(O=!0,Re())},Be=()=>{O&&(O=!1,j&&(cancelAnimationFrame(j),j=null))};window.onError=e=>{$(),alert(e),console.error(e)};const Re=()=>{window.performance.now();let t=Math.floor(1e3/60.5),n=performance.now(),o=0;const r=s=>{x.begin(),B.begin(),R.begin(),j=requestAnimationFrame(r),o=s-n,!(o<t)&&(n=s-o%t,ae(),x.end(),B.end(),R.end())};r(n)},Se=()=>{g=new AudioContext({sampleRate:48e3}),g.onstatechange=()=>{console.log(g==null?void 0:g.state)},N=g.createScriptProcessor(1024,0,1),N.onaudioprocess=e=>{se(e)},N.connect(g.destination),console.log("audio setup")},q=async()=>{g||Se(),!C&&(await(g==null?void 0:g.resume()),C=!0,console.log("audio playing"))},ue=async()=>{g&&C&&(await g.suspend(),C=!1,console.log("audio paused"))},fe=async()=>{de(),!z&&await q()},$=async()=>{await ue(),Be()};let Me=document.getElementById("play"),De=document.getElementById("pause"),Te=document.getElementById("mute"),z=!1;const ke=()=>{window.addEventListener("keydown",le),window.addEventListener("keyup",ie),Me.addEventListener("click",fe),De.addEventListener("click",$),Te.addEventListener("click",async()=>{O&&(g?C?await ue():await q():await q(),z=!z)}),[...document.getElementsByClassName("rom")].forEach(l=>{l.addEventListener("click",async w=>{let h=l.getAttribute("data-name");Ce(`roms/${h}.nes`)})});let t=document.getElementById("up"),n=document.getElementById("down"),o=document.getElementById("left"),r=document.getElementById("right"),s=document.getElementById("a"),c=document.getElementById("b"),u=document.getElementById("select"),_=document.getElementById("start");const a=(l,w)=>{l.addEventListener("touchstart",()=>{l.classList.toggle("pressed"),navigator.vibrate(70),p.update_button(w,!0)}),l.addEventListener("touchend",()=>{l.classList.toggle("pressed"),p.update_button(w,!1)})};a(s,0),a(c,1),a(u,2),a(_,3),a(t,4),a(n,5),a(o,6),a(r,7)},Ce=async e=>{await $();const t=await re(e);ce(t),await fe()},Oe=async e=>{console.log("init called with url ",e);const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(I,U);let r=document.getElementById("canvas-container");console.log(r);const s=Math.min(window.innerWidth/I,window.innerHeight/U,3);let c=(I-10)*s;r.style.width=c+"px",window.addEventListener("resize",()=>{const l=Math.min(window.innerWidth/I,window.innerHeight/U,3);let w=(I-10)*l;r.style.width=w+"px"});const u=await re(e),_=await ne();window.wasm=_,Y=_.memory,p=k.new_nes(u),window.nes=p;const a=(l,w)=>{l.key in X&&(l.preventDefault(),p.update_button(X[l.key],w))};le=l=>{a(l,!0)},ie=l=>{a(l,!1)},ae=()=>{p.step(),o.data.set(new Uint8ClampedArray(Y.buffer,p.frame_buffer_pointer(),xe)),n.putImageData(o,0,0)},se=l=>{p.load_audio_buffer(l.outputBuffer.getChannelData(0))},ce=l=>{p.change_rom(l)},ke()},Pe=async()=>{console.log("inside main");let e=document.getElementById("save"),t=document.getElementById("load");e.onclick=Fe,t.onclick=We;const n=document.getElementById("screen");n.getContext("2d"),document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const o=document.createElement("canvas");o.style.imageRendering="pixelated";const r=2;o.width=n.width*r,o.height=n.height*r;const s=o.getContext("2d");s.imageSmoothingEnabled=!1,s.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const c=o.toDataURL("image/png"),u=document.createElement("a");u.href=c,u.download="canvas-image.png",u.click()}),console.log("before init"),await Oe("roms/mario.nes"),console.log("after init"),de()};let V;const Fe=()=>{V=p.get_state(),console.log(V)},We=()=>{try{p.set_state(V)}catch(e){console.log(e)}};document.addEventListener("DOMContentLoaded",()=>{Pe().then(()=>console.log("after main"))});
