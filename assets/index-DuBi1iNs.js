(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();function de(e,t){return console.log("add called"),e+t}let i,A=null;function q(){return(A===null||A.byteLength===0)&&(A=new Uint8Array(i.memory.buffer)),A}function Q(e,t){return e=e>>>0,q().subarray(e/1,e/1+t)}const y=new Array(128).fill(void 0);y.push(void 0,null,!0,!1);function O(e){return y[e]}let S=y.length;function ue(e){e<132||(y[e]=S,S=e)}function fe(e){const t=O(e);return ue(e),t}const X=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&X.decode();function V(e,t){return e=e>>>0,X.decode(q().subarray(e,e+t))}let v=0;function C(e,t){const n=t(e.length*1,1)>>>0;return q().set(e,n/1),v=e.length,n}let B=null;function _e(){return(B===null||B.byteLength===0)&&(B=new Float32Array(i.memory.buffer)),B}function me(e,t){const n=t(e.length*4,4)>>>0;return _e().set(e,n/4),v=e.length,n}function ge(e){S===y.length&&y.push(y.length+1);const t=S;return S=y[t],y[t]=e,t}let R=null;function G(){return(R===null||R.byteLength===0)&&(R=new Int32Array(i.memory.buffer)),R}const $=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>i.__wbg_nes_free(e>>>0));class M{static __wrap(t){t=t>>>0;const n=Object.create(M.prototype);return n.__wbg_ptr=t,$.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,$.unregister(this),t}free(){const t=this.__destroy_into_raw();i.__wbg_nes_free(t)}static new_nes(t){const n=C(t,i.__wbindgen_malloc),o=v,r=i.nes_new_nes(n,o);return M.__wrap(r)}new_from_save_bytes(t){const n=C(t,i.__wbindgen_malloc),o=v,r=i.nes_new_from_save_bytes(this.__wbg_ptr,n,o);return M.__wrap(r)}step(){i.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return i.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){i.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=me(t,i.__wbindgen_malloc),o=v;i.nes_load_audio_buffer(this.__wbg_ptr,n,o,ge(t))}sample_rate(){return i.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=C(t,i.__wbindgen_malloc),o=v;i.nes_change_rom(this.__wbg_ptr,n,o)}get_state(){try{const r=i.__wbindgen_add_to_stack_pointer(-16);i.nes_get_state(r,this.__wbg_ptr);var t=G()[r/4+0],n=G()[r/4+1],o=Q(t,n).slice();return i.__wbindgen_free(t,n*1,1),o}finally{i.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=C(t,i.__wbindgen_malloc),o=v;i.nes_set_state(this.__wbg_ptr,n,o)}throw_rust_error(){i.nes_throw_rust_error(this.__wbg_ptr)}}async function we(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(o){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",o);else throw o}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function pe(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,o){new Uint8Array(O(o).buffer,O(o).byteOffset,O(o).byteLength).set(Q(t,n))},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError(V(t,n))},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return de(t>>>0,n>>>0)},e.wbg.__wbindgen_object_drop_ref=function(t){fe(t)},e.wbg.__wbindgen_throw=function(t,n){throw new Error(V(t,n))},e}function ye(e,t){return i=e.exports,Y.__wbindgen_wasm_module=t,B=null,R=null,A=null,i}async function Y(e){if(i!==void 0)return i;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=pe();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:o}=await we(await e,t);return ye(n,o)}var he=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function be(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Z={exports:{}};(function(e,t){(function(n,o){e.exports=o()})(he,function(){var n=function(){function o(_){return c.appendChild(_.dom),_}function r(_){for(var m=0;m<c.children.length;m++)c.children[m].style.display=m===_?"block":"none";s=_}var s=0,c=document.createElement("div");c.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",c.addEventListener("click",function(_){_.preventDefault(),r(++s%c.children.length)},!1);var d=(performance||Date).now(),f=d,a=0,l=o(new n.Panel("FPS","#0ff","#002")),w=o(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=o(new n.Panel("MB","#f08","#201"));return r(0),{REVISION:16,dom:c,addPanel:o,showPanel:r,begin:function(){d=(performance||Date).now()},end:function(){a++;var _=(performance||Date).now();if(w.update(_-d,200),_>f+1e3&&(l.update(1e3*a/(_-f),100),f=_,a=0,h)){var m=performance.memory;h.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return _},update:function(){d=this.end()},domElement:c,setMode:r}};return n.Panel=function(o,r,s){var c=1/0,d=0,f=Math.round,a=f(window.devicePixelRatio||1),l=80*a,w=48*a,h=3*a,_=2*a,m=3*a,b=15*a,E=74*a,L=30*a,I=document.createElement("canvas");I.width=l,I.height=w,I.style.cssText="width:80px;height:48px";var u=I.getContext("2d");return u.font="bold "+9*a+"px Helvetica,Arial,sans-serif",u.textBaseline="top",u.fillStyle=s,u.fillRect(0,0,l,w),u.fillStyle=r,u.fillText(o,h,_),u.fillRect(m,b,E,L),u.fillStyle=s,u.globalAlpha=.9,u.fillRect(m,b,E,L),{dom:I,update:function(k,ce){c=Math.min(c,k),d=Math.max(d,k),u.fillStyle=s,u.globalAlpha=1,u.fillRect(0,0,l,b),u.fillStyle=r,u.fillText(f(k)+" "+o+" ("+f(c)+"-"+f(d)+")",h,_),u.drawImage(I,m+a,b,E-a,L,m,b,E-a,L),u.fillRect(m+E-a,b,a,L),u.fillStyle=s,u.globalAlpha=.9,u.fillRect(m+E-a,b,a,f((1-k/ce)*L))}}},n})})(Z);var ve=Z.exports;const W=be(ve),J={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},x=256,P=240,Ee=x*P*4;async function ee(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}let F=null,g=null,U=null,D=!1,T=!1,te,ne,oe,re,ae,p,K;const se=()=>{console.log("startVideo"),T||(T=!0,Ie())},Le=()=>{T&&(T=!1,F&&(cancelAnimationFrame(F),F=null))};window.onError=e=>{z(),alert(e),console.error(e)};const Ie=()=>{window.performance.now();let e=document.querySelector(".stats");var t=new W;t.showPanel(0),t.dom.style.cssText="",e.appendChild(t.dom);var n=new W;n.showPanel(1),n.dom.style.cssText="",e.appendChild(n.dom);var o=new W;o.showPanel(2),o.dom.style.cssText="",e.appendChild(o.dom);let s=Math.floor(1e3/62),c=performance.now(),d=0;const f=a=>{t.begin(),n.begin(),o.begin(),F=requestAnimationFrame(f),d=a-c,!(d<s)&&(c=a-d%s,te(),t.end(),n.end(),o.end())};f(c)},xe=()=>{g=new AudioContext({sampleRate:48e3}),g.onstatechange=()=>{console.log(g==null?void 0:g.state)},U=g.createScriptProcessor(1024,0,1),U.onaudioprocess=e=>{ne(e)},U.connect(g.destination),console.log("audio setup")},j=async()=>{g||xe(),!D&&(await(g==null?void 0:g.resume()),D=!0,console.log("audio playing"))},ie=async()=>{g&&D&&(await g.suspend(),D=!1,console.log("audio paused"))},le=async()=>{se(),!H&&await j()},z=async()=>{await ie(),Le()};let Ae=document.getElementById("play"),Be=document.getElementById("pause"),Re=document.getElementById("mute"),H=!1;const Se=()=>{window.addEventListener("keydown",re),window.addEventListener("keyup",oe),Ae.addEventListener("click",le),Be.addEventListener("click",z),Re.addEventListener("click",async()=>{T&&(g?D?await ie():await j():await j(),H=!H)}),[...document.getElementsByClassName("rom")].forEach(l=>{l.addEventListener("click",async w=>{let h=l.getAttribute("data-name");Me(`roms/${h}.nes`)})});let t=document.getElementById("up"),n=document.getElementById("down"),o=document.getElementById("left"),r=document.getElementById("right"),s=document.getElementById("a"),c=document.getElementById("b"),d=document.getElementById("select"),f=document.getElementById("start");const a=(l,w)=>{l.addEventListener("touchstart",()=>{l.classList.toggle("pressed"),navigator.vibrate(70),p.update_button(w,!0)}),l.addEventListener("touchend",()=>{l.classList.toggle("pressed"),p.update_button(w,!1)})};a(s,0),a(c,1),a(d,2),a(f,3),a(t,4),a(n,5),a(o,6),a(r,7)},Me=async e=>{await z();const t=await ee(e);ae(t),await le()},De=async e=>{console.log("init called with url ",e);const n=document.querySelector("#screen").getContext("2d"),o=n.createImageData(x,P);let r=document.getElementById("canvas-container");console.log(r);const s=Math.min(window.innerWidth/x,window.innerHeight/P,3);let c=(x-10)*s;r.style.width=c+"px",window.addEventListener("resize",()=>{const l=Math.min(window.innerWidth/x,window.innerHeight/P,3);let w=(x-10)*l;r.style.width=w+"px"});const d=await ee(e),f=await Y();window.wasm=f,K=f.memory,p=M.new_nes(d),window.nes=p;const a=(l,w)=>{l.key in J&&(l.preventDefault(),p.update_button(J[l.key],w))};re=l=>{a(l,!0)},oe=l=>{a(l,!1)},te=()=>{p.step(),o.data.set(new Uint8ClampedArray(K.buffer,p.frame_buffer_pointer(),Ee)),n.putImageData(o,0,0)},ne=l=>{p.load_audio_buffer(l.outputBuffer.getChannelData(0))},ae=l=>{p.change_rom(l)},Se()},Te=async()=>{console.log("inside main");let e=document.getElementById("save"),t=document.getElementById("load");e.onclick=ke,t.onclick=Ce;const n=document.getElementById("screen");n.getContext("2d"),document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const o=document.createElement("canvas");o.style.imageRendering="pixelated";const r=2;o.width=n.width*r,o.height=n.height*r;const s=o.getContext("2d");s.imageSmoothingEnabled=!1,s.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const c=o.toDataURL("image/png"),d=document.createElement("a");d.href=c,d.download="canvas-image.png",d.click()}),console.log("before init"),await De("roms/mario.nes"),console.log("after init"),se()};let N;const ke=()=>{N=p.get_state(),console.log(N)},Ce=()=>{try{p.set_state(N)}catch(e){console.log(e)}};document.addEventListener("DOMContentLoaded",()=>{Te().then(()=>console.log("after main"))});
