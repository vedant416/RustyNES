(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(o){if(o.ep)return;o.ep=!0;const s=n(o);fetch(o.href,s)}})();function _e(e,t){return console.log("add called"),e+t}let l;const y=new Array(128).fill(void 0);y.push(void 0,null,!0,!1);function C(e){return y[e]}let D=y.length;function me(e){e<132||(y[e]=D,D=e)}function ge(e){const t=C(e);return me(e),t}let R=null;function z(){return(R===null||R.byteLength===0)&&(R=new Uint8Array(l.memory.buffer)),R}function Z(e,t){return e=e>>>0,z().subarray(e/1,e/1+t)}const ee=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&ee.decode();function G(e,t){return e=e>>>0,ee.decode(z().subarray(e,e+t))}let v=0;function P(e,t){const n=t(e.length*1,1)>>>0;return z().set(e,n/1),v=e.length,n}let S=null;function pe(){return(S===null||S.byteLength===0)&&(S=new Float32Array(l.memory.buffer)),S}function we(e,t){const n=t(e.length*4,4)>>>0;return pe().set(e,n/4),v=e.length,n}function ye(e){D===y.length&&y.push(y.length+1);const t=D;return D=y[t],y[t]=e,t}let M=null;function $(){return(M===null||M.byteLength===0)&&(M=new Int32Array(l.memory.buffer)),M}const J=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>l.__wbg_nes_free(e>>>0));class T{static __wrap(t){t=t>>>0;const n=Object.create(T.prototype);return n.__wbg_ptr=t,J.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,J.unregister(this),t}free(){const t=this.__destroy_into_raw();l.__wbg_nes_free(t)}static new_nes(t){const n=P(t,l.__wbindgen_malloc),r=v,o=l.nes_new_nes(n,r);return T.__wrap(o)}new_from_save_bytes(t){const n=P(t,l.__wbindgen_malloc),r=v,o=l.nes_new_from_save_bytes(this.__wbg_ptr,n,r);return T.__wrap(o)}step(){l.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return l.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){l.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=we(t,l.__wbindgen_malloc),r=v;l.nes_load_audio_buffer(this.__wbg_ptr,n,r,ye(t))}sample_rate(){return l.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=P(t,l.__wbindgen_malloc),r=v;l.nes_change_rom(this.__wbg_ptr,n,r)}get_state(){try{const o=l.__wbindgen_add_to_stack_pointer(-16);l.nes_get_state(o,this.__wbg_ptr);var t=$()[o/4+0],n=$()[o/4+1],r=Z(t,n).slice();return l.__wbindgen_free(t,n*1,1),r}finally{l.__wbindgen_add_to_stack_pointer(16)}}set_state(t){const n=P(t,l.__wbindgen_malloc),r=v;l.nes_set_state(this.__wbg_ptr,n,r)}throw_rust_error(){l.nes_throw_rust_error(this.__wbg_ptr)}}async function he(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function be(){const e={};return e.wbg={},e.wbg.__wbg_onError_e4eef107580251b0=function(t,n){window.onError(G(t,n))},e.wbg.__wbindgen_object_drop_ref=function(t){ge(t)},e.wbg.__wbg_add_1f5a7f294ef132d5=function(t,n){return _e(t>>>0,n>>>0)},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,r){new Uint8Array(C(r).buffer,C(r).byteOffset,C(r).byteLength).set(Z(t,n))},e.wbg.__wbindgen_throw=function(t,n){throw new Error(G(t,n))},e}function ve(e,t){return l=e.exports,te.__wbindgen_wasm_module=t,S=null,M=null,R=null,l}async function te(e){if(l!==void 0)return l;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=be();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await he(await e,t);return ve(n,r)}var Ee=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Le(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var ne={exports:{}};(function(e,t){(function(n,r){e.exports=r()})(Ee,function(){var n=function(){function r(_){return c.appendChild(_.dom),_}function o(_){for(var m=0;m<c.children.length;m++)c.children[m].style.display=m===_?"block":"none";s=_}var s=0,c=document.createElement("div");c.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",c.addEventListener("click",function(_){_.preventDefault(),o(++s%c.children.length)},!1);var u=(performance||Date).now(),f=u,a=0,i=r(new n.Panel("FPS","#0ff","#002")),p=r(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=r(new n.Panel("MB","#f08","#201"));return o(0),{REVISION:16,dom:c,addPanel:r,showPanel:o,begin:function(){u=(performance||Date).now()},end:function(){a++;var _=(performance||Date).now();if(p.update(_-u,200),_>f+1e3&&(i.update(1e3*a/(_-f),100),f=_,a=0,h)){var m=performance.memory;h.update(m.usedJSHeapSize/1048576,m.jsHeapSizeLimit/1048576)}return _},update:function(){u=this.end()},domElement:c,setMode:o}};return n.Panel=function(r,o,s){var c=1/0,u=0,f=Math.round,a=f(window.devicePixelRatio||1),i=80*a,p=48*a,h=3*a,_=2*a,m=3*a,b=15*a,E=74*a,L=30*a,A=document.createElement("canvas");A.width=i,A.height=p,A.style.cssText="width:80px;height:48px";var d=A.getContext("2d");return d.font="bold "+9*a+"px Helvetica,Arial,sans-serif",d.textBaseline="top",d.fillStyle=s,d.fillRect(0,0,i,p),d.fillStyle=o,d.fillText(r,h,_),d.fillRect(m,b,E,L),d.fillStyle=s,d.globalAlpha=.9,d.fillRect(m,b,E,L),{dom:A,update:function(O,fe){c=Math.min(c,O),u=Math.max(u,O),d.fillStyle=s,d.globalAlpha=1,d.fillRect(0,0,i,b),d.fillStyle=o,d.fillText(f(O)+" "+r+" ("+f(c)+"-"+f(u)+")",h,_),d.drawImage(A,m+a,b,E-a,L,m,b,E-a,L),d.fillRect(m+E-a,b,a,L),d.fillStyle=s,d.globalAlpha=.9,d.fillRect(m+E-a,b,a,f((1-O/fe)*L))}}},n})})(ne);var Ae=ne.exports;const K=Le(Ae),Q={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},I=256,W=240,Ie=I*W*4;async function oe(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}let U=null,g=null,j=null,k=!1,F=!1,re,ae,se,ie,le,w,X,Y=!1,x,B;const ce=()=>{if(console.log("startVideo"),!Y){Y=!0;let e=document.querySelector(".stats");x=new K,x.showPanel(0),x.dom.style.cssText="",e.appendChild(x.dom),B=new K,B.showPanel(1),B.dom.style.cssText="",e.appendChild(B.dom)}F||(F=!0,Be())},xe=()=>{F&&(F=!1,U&&(cancelAnimationFrame(U),U=null))};window.onError=e=>{V(),alert(e),console.error(e)};const Be=()=>{let t=Math.floor(1e3/60),n=performance.now(),r=0,o=0,s=0,c=n,u=0;const f=a=>{if(x.begin(),B.begin(),U=requestAnimationFrame(f),r=a-n,r<t){console.log("Rendering too fast");return}if(n=a-r%t,o++,re(),u=a-c,s+=u,c=a,o%60===0){let i=1e3/(s/60);console.log(i.toFixed(2)),o=0,s=0}x.end(),B.end()};f(n)},Re=()=>{g=new AudioContext({sampleRate:44100}),g.onstatechange=()=>{console.log(g==null?void 0:g.state)},j=g.createScriptProcessor(1024,0,1),j.onaudioprocess=e=>{ae(e)},j.connect(g.destination),console.log("audio setup")},H=async()=>{g||Re(),!k&&(await(g==null?void 0:g.resume()),k=!0,console.log("audio playing"))},de=async()=>{g&&k&&(await g.suspend(),k=!1,console.log("audio paused"))},ue=async()=>{ce(),!N&&await H()},V=async()=>{await de(),xe()};let Se=document.getElementById("play"),Me=document.getElementById("pause"),N=!1,De=document.getElementById("mute");const Te=()=>{window.addEventListener("keydown",ie),window.addEventListener("keyup",se),Se.addEventListener("click",ue),Me.addEventListener("click",V),De.addEventListener("click",async()=>{F&&(g?k?await de():await H():await H(),N=!N)}),[...document.getElementsByClassName("rom")].forEach(i=>{i.addEventListener("click",async p=>{let h=i.getAttribute("data-name");ke(`roms/${h}.nes`)})});let t=document.getElementById("up"),n=document.getElementById("down"),r=document.getElementById("left"),o=document.getElementById("right"),s=document.getElementById("a"),c=document.getElementById("b"),u=document.getElementById("select"),f=document.getElementById("start");const a=(i,p)=>{i.addEventListener("touchstart",()=>{i.classList.toggle("pressed"),navigator.vibrate(70),w.update_button(p,!0)}),i.addEventListener("touchend",()=>{i.classList.toggle("pressed"),w.update_button(p,!1)})};a(s,0),a(c,1),a(u,2),a(f,3),a(t,4),a(n,5),a(r,6),a(o,7)},ke=async e=>{await V();const t=await oe(e);le(t),await ue()},Fe=async e=>{console.log("init called with url ",e);const n=document.querySelector("#screen").getContext("2d"),r=n.createImageData(I,W);let o=document.getElementById("canvas-container");console.log(o);const s=Math.min(window.innerWidth/I,window.innerHeight/W,3);let c=(I-10)*s;o.style.width=c+"px",window.addEventListener("resize",()=>{const i=Math.min(window.innerWidth/I,window.innerHeight/W,3);let p=(I-10)*i;o.style.width=p+"px"});const u=await oe(e),f=await te();window.wasm=f,X=f.memory,w=T.new_nes(u),window.nes=w;const a=(i,p)=>{i.key in Q&&(i.preventDefault(),w.update_button(Q[i.key],p))};ie=i=>{a(i,!0)},se=i=>{a(i,!1)},re=()=>{w.step(),r.data.set(new Uint8ClampedArray(X.buffer,w.frame_buffer_pointer(),Ie)),n.putImageData(r,0,0)},ae=i=>{w.load_audio_buffer(i.outputBuffer.getChannelData(0))},le=i=>{w.change_rom(i)},Te()},Oe=async()=>{console.log("inside main");let e=document.getElementById("save"),t=document.getElementById("load");e.onclick=Pe,t.onclick=Ce;const n=document.getElementById("screen");document.getElementById("downloadBtn").addEventListener("click",()=>{console.log("Download button clicked");const r=2,o=document.createElement("canvas"),s=o.getContext("2d");o.width=n.width*r,o.height=n.height*r,o.style.imageRendering="pixelated",s.imageSmoothingEnabled=!1,s.drawImage(n,0,0,n.width,n.height,0,0,o.width,o.height);const c=o.toDataURL("image/png"),u=document.createElement("a");u.href=c,u.download="canvas-image.png",u.click()}),await Fe("roms/mario.nes"),ce()};let q;const Pe=()=>{q=w.get_state(),console.log(q)},Ce=()=>{try{w.set_state(q)}catch(e){console.log(e)}};document.addEventListener("DOMContentLoaded",Oe);
