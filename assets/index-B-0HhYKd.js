(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();function J(t,e){return console.log("add called"),t+e}let s,m=null;function w(){return(m===null||m.byteLength===0)&&(m=new Uint8Array(s.memory.buffer)),m}function Q(t,e){return t=t>>>0,w().subarray(t/1,t/1+e)}const f=new Array(128).fill(void 0);f.push(void 0,null,!0,!1);function y(t){return f[t]}let g=f.length;function X(t){t<132||(f[t]=g,g=t)}function Y(t){const e=y(t);return X(t),e}const D=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&D.decode();function x(t,e){return t=t>>>0,D.decode(w().subarray(t,t+e))}let _=0;function O(t,e){const n=e(t.length*1,1)>>>0;return w().set(t,n/1),_=t.length,n}let b=null;function Z(){return(b===null||b.byteLength===0)&&(b=new Float32Array(s.memory.buffer)),b}function ee(t,e){const n=e(t.length*4,4)>>>0;return Z().set(t,n/4),_=t.length,n}function S(t){g===f.length&&f.push(f.length+1);const e=g;return g=f[e],f[e]=t,e}const A=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},te=typeof A.encodeInto=="function"?function(t,e){return A.encodeInto(t,e)}:function(t,e){const n=A.encode(t);return e.set(n),{read:t.length,written:n.length}};function ne(t,e,n){if(n===void 0){const c=A.encode(t),d=e(c.length,1)>>>0;return w().subarray(d,d+c.length).set(c),_=c.length,d}let r=t.length,o=e(r,1)>>>0;const i=w();let a=0;for(;a<r;a++){const c=t.charCodeAt(a);if(c>127)break;i[o+a]=c}if(a!==r){a!==0&&(t=t.slice(a)),o=n(o,r,r=a+t.length*3,1)>>>0;const c=w().subarray(o+a,o+r),d=te(t,c);a+=d.written,o=n(o,r,a,1)>>>0}return _=a,o}let p=null;function T(){return(p===null||p.byteLength===0)&&(p=new Int32Array(s.memory.buffer)),p}const I=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(t=>s.__wbg_nes_free(t>>>0));class v{static __wrap(e){e=e>>>0;const n=Object.create(v.prototype);return n.__wbg_ptr=e,I.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,I.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_nes_free(e)}static new_nes(e){const n=O(e,s.__wbindgen_malloc),r=_,o=s.nes_new_nes(n,r);return v.__wrap(o)}step(){s.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return s.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(e,n){s.nes_update_button(this.__wbg_ptr,e,n)}load_audio_buffer(e){var n=ee(e,s.__wbindgen_malloc),r=_;s.nes_load_audio_buffer(this.__wbg_ptr,n,r,S(e))}sample_rate(){return s.nes_sample_rate(this.__wbg_ptr)}change_rom(e){const n=O(e,s.__wbindgen_malloc),r=_;s.nes_change_rom(this.__wbg_ptr,n,r)}}async function re(t,e){if(typeof Response=="function"&&t instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(t,e)}catch(r){if(t.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await t.arrayBuffer();return await WebAssembly.instantiate(n,e)}else{const n=await WebAssembly.instantiate(t,e);return n instanceof WebAssembly.Instance?{instance:n,module:t}:n}}function oe(){const t={};return t.wbg={},t.wbg.__wbindgen_copy_to_typed_array=function(e,n,r){new Uint8Array(y(r).buffer,y(r).byteOffset,y(r).byteLength).set(Q(e,n))},t.wbg.__wbg_add_1f5a7f294ef132d5=function(e,n){return J(e>>>0,n>>>0)},t.wbg.__wbindgen_object_drop_ref=function(e){Y(e)},t.wbg.__wbg_new_abda76e883ba8a5f=function(){const e=new Error;return S(e)},t.wbg.__wbg_stack_658279fe44541cf6=function(e,n){const r=y(n).stack,o=ne(r,s.__wbindgen_malloc,s.__wbindgen_realloc),i=_;T()[e/4+1]=i,T()[e/4+0]=o},t.wbg.__wbg_error_f851667af71bcfc6=function(e,n){let r,o;try{r=e,o=n,console.error(x(e,n))}finally{s.__wbindgen_free(r,o,1)}},t.wbg.__wbindgen_throw=function(e,n){throw new Error(x(e,n))},t}function se(t,e){return s=t.exports,B.__wbindgen_wasm_module=e,b=null,p=null,m=null,s}async function B(t){if(s!==void 0)return s;typeof t>"u"&&(t=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const e=oe();(typeof t=="string"||typeof Request=="function"&&t instanceof Request||typeof URL=="function"&&t instanceof URL)&&(t=fetch(t));const{instance:n,module:r}=await re(await t,e);return se(n,r)}const M={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},R=256,C=240,ae=R*C*4;async function P(t){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch ROM: ${e.statusText}`);const n=await e.arrayBuffer();return new Uint8Array(n)}let L=null,u=null,F=null,h=!1,E=!1,N,U,j,q,z;const H=()=>{E||(E=!0,ce())},ie=()=>{E&&(E=!1,L&&(cancelAnimationFrame(L),L=null))},ce=()=>{let e=window.performance.now(),n=0,r=0;const o=()=>{if(L=requestAnimationFrame(o),r=window.performance.now(),n=r-e,n<16.67){console.log("Rendering too fast");return}e=r-n%16.67,N()};o()},le=()=>{u=new AudioContext({sampleRate:48e3}),F=u.createScriptProcessor(1024,0,1),F.onaudioprocess=t=>{U(t)},F.connect(u.destination),console.log("audio setup")},k=async()=>{u||le(),!h&&(await(u==null?void 0:u.resume()),h=!0,console.log("audio playing"))},V=async()=>{u&&h&&(await u.suspend(),h=!1,console.log("audio paused"))},$=async()=>{H(),await k()},G=async()=>{await V(),ie()};let ue=document.getElementById("play"),fe=document.getElementById("pause"),de=document.getElementById("mute");const _e=()=>{window.addEventListener("keydown",q),window.addEventListener("keyup",j),ue.addEventListener("click",$),fe.addEventListener("click",G),de.addEventListener("click",async()=>{E&&(u?h?await V():await k():await k())}),[...document.getElementsByClassName("rom")].forEach(e=>{e.addEventListener("click",async n=>{we(`roms/${e.textContent}.nes`)})})},we=async t=>{await G();const e=await P(t);z(e),await $()},me=async t=>{const e=document.querySelector("#screen"),n=e.getContext("2d"),r=n.createImageData(R,C);W(e),document.addEventListener("resize",()=>W(e));const o=await P(t),a=(await B()).memory,c=v.new_nes(o),d=(l,K)=>{l.key in M&&(l.preventDefault(),c.update_button(M[l.key],K))};q=l=>{d(l,!0)},j=l=>{d(l,!1)},N=()=>{c.step(),r.data.set(new Uint8ClampedArray(a.buffer,c.frame_buffer_pointer(),ae)),n.putImageData(r,0,0)},U=l=>{c.load_audio_buffer(l.outputBuffer.getChannelData(0))},z=l=>{c.change_rom(l)},_e()};function W(t){const e=Math.min(window.innerWidth/R,window.innerHeight/C,2);t.style.width=`${R*e}px`,t.style.height=`${C*e}px`}const ye=async()=>{await me("roms/mario.nes"),H()};document.addEventListener("DOMContentLoaded",ye);
