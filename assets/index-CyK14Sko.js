(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(o){if(o.ep)return;o.ep=!0;const a=n(o);fetch(o.href,a)}})();let s,w=null;function _(){return(w===null||w.byteLength===0)&&(w=new Uint8Array(s.memory.buffer)),w}function F(e,t){return e=e>>>0,_().subarray(e/1,e/1+t)}const u=new Array(128).fill(void 0);u.push(void 0,null,!0,!1);function b(e){return u[e]}let y=u.length;function S(e){e<132||(u[e]=y,y=e)}function D(e){const t=b(e);return S(e),t}const T=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&T.decode();function L(e,t){return e=e>>>0,T.decode(_().subarray(e,e+t))}let d=0;function x(e,t){const n=t(e.length*1,1)>>>0;return _().set(e,n/1),d=e.length,n}let p=null;function k(){return(p===null||p.byteLength===0)&&(p=new Float32Array(s.memory.buffer)),p}function U(e,t){const n=t(e.length*4,4)>>>0;return k().set(e,n/4),d=e.length,n}function C(e){y===u.length&&u.push(u.length+1);const t=y;return y=u[t],u[t]=e,t}const E=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},B=typeof E.encodeInto=="function"?function(e,t){return E.encodeInto(e,t)}:function(e,t){const n=E.encode(e);return t.set(n),{read:e.length,written:n.length}};function N(e,t,n){if(n===void 0){const c=E.encode(e),l=t(c.length,1)>>>0;return _().subarray(l,l+c.length).set(c),d=c.length,l}let r=e.length,o=t(r,1)>>>0;const a=_();let i=0;for(;i<r;i++){const c=e.charCodeAt(i);if(c>127)break;a[o+i]=c}if(i!==r){i!==0&&(e=e.slice(i)),o=n(o,r,r=i+e.length*3,1)>>>0;const c=_().subarray(o+i,o+r),l=B(e,c);i+=l.written,o=n(o,r,i,1)>>>0}return d=i,o}let m=null;function v(){return(m===null||m.byteLength===0)&&(m=new Int32Array(s.memory.buffer)),m}const R=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_nes_free(e>>>0));class A{static __wrap(t){t=t>>>0;const n=Object.create(A.prototype);return n.__wbg_ptr=t,R.register(n,n.__wbg_ptr,n),n}__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,R.unregister(this),t}free(){const t=this.__destroy_into_raw();s.__wbg_nes_free(t)}static new_nes(t){const n=x(t,s.__wbindgen_malloc),r=d,o=s.nes_new_nes(n,r);return A.__wrap(o)}step(){s.nes_step(this.__wbg_ptr)}frame_buffer_pointer(){return s.nes_frame_buffer_pointer(this.__wbg_ptr)>>>0}update_button(t,n){s.nes_update_button(this.__wbg_ptr,t,n)}load_audio_buffer(t){var n=U(t,s.__wbindgen_malloc),r=d;s.nes_load_audio_buffer(this.__wbg_ptr,n,r,C(t))}sample_rate(){return s.nes_sample_rate(this.__wbg_ptr)}change_rom(t){const n=x(t,s.__wbindgen_malloc),r=d;s.nes_change_rom(this.__wbg_ptr,n,r)}}async function j(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const n=await e.arrayBuffer();return await WebAssembly.instantiate(n,t)}else{const n=await WebAssembly.instantiate(e,t);return n instanceof WebAssembly.Instance?{instance:n,module:e}:n}}function P(){const e={};return e.wbg={},e.wbg.__wbindgen_copy_to_typed_array=function(t,n,r){new Uint8Array(b(r).buffer,b(r).byteOffset,b(r).byteLength).set(F(t,n))},e.wbg.__wbindgen_object_drop_ref=function(t){D(t)},e.wbg.__wbg_new_abda76e883ba8a5f=function(){const t=new Error;return C(t)},e.wbg.__wbg_stack_658279fe44541cf6=function(t,n){const r=b(n).stack,o=N(r,s.__wbindgen_malloc,s.__wbindgen_realloc),a=d;v()[t/4+1]=a,v()[t/4+0]=o},e.wbg.__wbg_error_f851667af71bcfc6=function(t,n){let r,o;try{r=t,o=n,console.error(L(t,n))}finally{s.__wbindgen_free(r,o,1)}},e.wbg.__wbindgen_throw=function(t,n){throw new Error(L(t,n))},e}function q(e,t){return s=e.exports,M.__wbindgen_wasm_module=t,p=null,m=null,w=null,s}async function M(e){if(s!==void 0)return s;typeof e>"u"&&(e=new URL("/RustyNES/pkg/rusty_nes_wasm_bg.wasm",import.meta.url));const t=P();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:n,module:r}=await j(await e,t);return q(n,r)}const I={l:0,k:1,Shift:2,Enter:3,w:4,s:5,a:6,d:7},g=256,h=240,z=g*h*4;let W,f=!1;function O(e){const t=Math.min(window.innerWidth/g,window.innerHeight/h,2);e.style.width=`${g*t}px`,e.style.height=`${h*t}px`}function H(e){const t=new AudioContext({sampleRate:e.sample_rate()}),n=t.createScriptProcessor(1024*2,0,1);return n.onaudioprocess=r=>{f||e.load_audio_buffer(r.outputBuffer.getChannelData(0))},n.connect(t.destination),t}function $(e){window.addEventListener("keydown",n=>t(n,!0)),window.addEventListener("keyup",n=>t(n,!1));function t(n,r){n.key in I&&(n.preventDefault(),e.update_button(I[n.key],r))}}async function G(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch ROM: ${t.statusText}`);const n=await t.arrayBuffer();return new Uint8Array(n)}async function K(e){const t=await G("roms/mario.nes"),n=await M(),r=A.new_nes(t),o=e.getContext("2d"),a=o.createImageData(g,h);$(r),W=H(r);const i=()=>{requestAnimationFrame(i),!f&&(r.step(),a.data.set(new Uint8ClampedArray(n.memory.buffer,r.frame_buffer_pointer(),z)),o.putImageData(a,0,0))};i()}function V(){f=!1;const e=document.querySelector("#screen");e.width=g,e.height=h,O(e),document.addEventListener("resize",()=>O(e)),document.addEventListener("click",()=>{W==null&&K(e)}),document.getElementById("pause").addEventListener("click",()=>{f=!f,document.getElementById("pause").textContent=f?"Resume":"Pause"}),window.addEventListener("blur",function(){f=!0,document.getElementById("pause").textContent="Resume"}),window.addEventListener("focus",function(){f=!1,document.getElementById("pause").textContent="Pause"})}document.addEventListener("DOMContentLoaded",V);
